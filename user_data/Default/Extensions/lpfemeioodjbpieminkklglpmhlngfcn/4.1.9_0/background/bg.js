import{c as bt,d as zt,e as Vt,g as Jt,h as W,j as $,k as Zt,m as te}from"../chunks/NKHHNHC6.js";import{a as jt}from"../chunks/GBCF3LJF.js";import{a as R}from"../chunks/PE6QTJVW.js";import{g as wt}from"../chunks/4LKEOLLR.js";import{a as Xt}from"../chunks/Z5WQUI2X.js";import{h as Y,j as ee,k as re}from"../chunks/FRD2ED6S.js";import"../chunks/MHFF22NY.js";import{c as ht}from"../chunks/3IHGIM7R.js";import"../chunks/CUN77TMN.js";import{a as At,c as Kt,d as Yt}from"../chunks/A3QRDAMY.js";import{z as pt}from"../chunks/DLHF3GTD.js";import{a as Wt}from"../chunks/FNOI4VUF.js";import{a as v,c as qt,d as Ft,f as Ht}from"../chunks/DJKLXMKD.js";import"../chunks/SZ3C6HJE.js";import{d as ut,f as dt}from"../chunks/EWET23YO.js";import"../chunks/AZMC6STA.js";import"../chunks/MM6H3LLZ.js";import{c as y,g as ot,h as it,i as ct,j as F,q as Dt,r as O,t as H}from"../chunks/WUMYY75E.js";import{a as b}from"../chunks/42TZCCKB.js";import{a as $t,d as lt}from"../chunks/U3PG3M5Y.js";import{a as l}from"../chunks/USLLVG5P.js";import{f as _}from"../chunks/UTGLRY7A.js";var se=()=>{v(async(s,t,e,r)=>{if(s==="shortcut")switch(t){case"ShortCuts_getContentOfURL":{let{URL:a,timeOut:o,withSnapshot:i}=e;if(o){let c=null,u=await Promise.race([bt(a,"",i),new Promise(n=>{c=setTimeout(()=>{n({success:!1})},o)})]);return clearTimeout(c),{data:u,success:u.success,message:"ok"}}else{let c=await bt(a);return{data:c,success:c.success,message:"ok"}}}case"ShortCuts_getHtmlOfURL":{let{URL:a}=e,o=await Vt(a);return{data:o,success:o.success,message:"ok"}}case"ShortCuts_getContentOfSearchEngine":{let{URL:a,proxyFetch:o}=e,i=await zt(a,o);return{data:i,success:i.success,message:"ok"}}default:break}})};var S=_(b());var ae=()=>{v(async(s,t,e,r)=>{if(s==="client")switch(t){case"Client_logCallApiRequest":{return Jt(e),{success:!0,message:"ok",data:{}};break}default:break}})};var ne=_(b()),G=class{bardChat;constructor(t){this.bardChat=t}async auth(t){await this.bardChat.auth()}async preAuth(){await this.bardChat.checkAuth()}get status(){return this.bardChat.status}async createConversation(){return Promise.resolve("")}async removeConversation(t){return await this.bardChat.reset(),Promise.resolve(!0)}sendQuestion=async(t,e,r,a)=>{let o=l();await this.bardChat.askChatGPT(r.question,{taskId:r.messageId,regenerate:a.regenerate,include_history:a.includeHistory,max_history_message_cnt:a.maxHistoryMessageCnt},async({type:i,done:c,error:u,data:n})=>{e.tab?.id&&await this.sendResponseToClient(e.tab.id,{taskId:t,data:{text:n.text,parentMessageId:r.messageId,conversationId:n.conversationId,messageId:o},error:u,done:c})})};async abortAskQuestion(t){return await this.bardChat.abortTask(t)}async destroy(){await this.bardChat.destroy()}async sendResponseToClient(t,e){await ne.default.tabs.sendMessage(t,{id:y,event:"Client_askChatGPTQuestionResponse",data:e})}};var oe=_(b()),M=class{bingChat;constructor(t){this.bingChat=t}async auth(t){await this.bingChat.auth()}async preAuth(){await this.bingChat.auth()}get status(){return this.bingChat.status}async createConversation(){return Promise.resolve("")}async removeConversation(t){return await this.bingChat.removeConversation(t),Promise.resolve(!0)}sendQuestion=async(t,e,r,a)=>{let o=l();await this.bingChat.askChatGPT(r.question,{taskId:r.messageId,regenerate:a.regenerate,include_history:a.includeHistory,max_history_message_cnt:a.maxHistoryMessageCnt,clientTabId:e?.tab?.id},async({type:i,done:c,error:u,data:n})=>{e.tab?.id&&await this.sendResponseToClient(e.tab.id,{taskId:t,data:{text:n.text,parentMessageId:r.messageId,conversationId:n.conversationId,messageId:o},error:u,done:c})})};async abortAskQuestion(t){return await this.bingChat.abortTask(t)}async destroy(){await this.bingChat.destroy()}async sendResponseToClient(t,e){await oe.default.tabs.sendMessage(t,{id:y,event:"Client_askChatGPTQuestionResponse",data:e})}};var I=class{chatAdapter;constructor(t){this.chatAdapter=t}async preAuth(){await this.chatAdapter.preAuth()}async auth(t){await this.chatAdapter.auth(t)}get status(){return this.chatAdapter.status}sendQuestion=(t,e,r,a)=>this.chatAdapter.sendQuestion(t,e,r,a);async abortAskQuestion(t){return await this.chatAdapter.abortAskQuestion(t)}async destroy(){await this.chatAdapter.destroy()}async createConversation(){return await this.chatAdapter.createConversation()}async removeConversation(t){return await this.chatAdapter.removeConversation(t)}};var ie=_(b()),N=class{claudeChat;constructor(t){this.claudeChat=t}async auth(t){await this.claudeChat.auth()}async preAuth(){await this.claudeChat.preAuth()}get status(){return this.claudeChat.status}async createConversation(){return await this.claudeChat.createConversation()}async removeConversation(t){return await this.claudeChat.removeConversation(t),Promise.resolve(!0)}sendQuestion=async(t,e,r,a)=>{let o=l();await this.claudeChat.askChatGPT(r.question,{taskId:r.messageId,regenerate:a.regenerate,include_history:a.includeHistory,max_history_message_cnt:a.maxHistoryMessageCnt},async({type:i,done:c,error:u,data:n})=>{e.tab?.id&&await this.sendResponseToClient(e.tab.id,{taskId:t,data:{text:n.text,parentMessageId:r.messageId,conversationId:n.conversationId,messageId:o},error:u,done:c})})};async abortAskQuestion(t){return await this.claudeChat.abortTask(t)}async destroy(){await this.claudeChat.destroy()}async sendResponseToClient(t,e){await ie.default.tabs.sendMessage(t,{id:y,event:"Client_askChatGPTQuestionResponse",data:e})}};var ce=_(b()),B=class{openAIChat;constructor(t){this.openAIChat=t}async preAuth(){return this.openAIChat.preAuth()}async auth(t){await this.openAIChat.auth(t)}get status(){return this.openAIChat.status}sendQuestion=async(t,e,r,a)=>{let o=l();await this.openAIChat.askChatGPT(r.question,{taskId:r.messageId,regenerate:a.regenerate,include_history:a.includeHistory,max_history_message_cnt:a.maxHistoryMessageCnt,newConversation:!!a.meta?.newConversation},async({type:i,done:c,error:u,data:n})=>{e.tab?.id&&await this.sendResponseToClient(e.tab.id,{taskId:t,data:{text:n.text,parentMessageId:r.messageId,conversationId:n.conversationId,messageId:o},error:u,done:c})})};async abortAskQuestion(t){try{return await this.openAIChat.abortAskQuestion(t),!0}catch{return!1}}async createConversation(){let t=await this.openAIChat.createConversation();return t&&t.conversationId?t.conversationId:Promise.resolve("")}async removeConversation(t){return await this.openAIChat.removeConversation(t)}destroy(){return this.openAIChat.destroy()}async sendResponseToClient(t,e){await ce.default.tabs.sendMessage(t,{id:y,event:"Client_askChatGPTQuestionResponse",data:e})}};var Pt=_(b());var Tt=class{log;status="needAuth";active=!1;taskList={};constructor(t){this.log=new R("Background/Chat/"+t)}async auth(t){this.active=!0,await this.updateClientStatus("success")}async destroy(){await this.updateClientStatus("needAuth"),this.active=!1}async updateClientStatus(t){this.active&&(this.status=t,this.log.info("updateStatus",this.status))}async abortTask(t){return this.taskList[t]&&(this.taskList[t](),delete this.taskList[t]),!0}},w=Tt;var ue=[{title:"gpt-3.5-turbo",titleTag:"",value:"gpt-3.5-turbo",maxTokens:4096,tags:[],descriptions:[{label:"client:provider__model__tooltip_card__label__max_token",value:"client:provider__model__tooltip_card__label__max_token__suffix"},{label:"client:provider__model__tooltip_card__label__description",value:"client:provider__chatgpt__model__gpt_3_5__description"}]},{title:"gpt-4",titleTag:"",value:"gpt-4",maxTokens:8192,tags:[],descriptions:[{label:"client:provider__model__tooltip_card__label__max_token",value:"client:provider__model__tooltip_card__label__max_token__suffix"},{label:"client:provider__model__tooltip_card__label__description",value:"client:provider__chatgpt__model__gpt_4__description"}]},{title:"gpt-3.5-turbo-16k",titleTag:"",value:"gpt-3.5-turbo-16k",maxTokens:16384,tags:[],descriptions:[{label:"client:provider__model__tooltip_card__label__max_token",value:"client:provider__model__tooltip_card__label__max_token__suffix"},{label:"client:provider__model__tooltip_card__label__description",value:"client:provider__chatgpt__model__gpt_3_5_16k__description"}]}];var T=new R("Background/Chat/UseChatGPTPlusChat"),Z=class extends w{status="needAuth";lastActiveTabId;token;conversationId;constructor(){super("UseChatGPTPlusChat"),this.init()}init(){T.info("init")}async preAuth(){this.active=!0,await this.checkTokenAndUpdateStatus()}async auth(t){this.active=!0,this.lastActiveTabId=t,await this.checkTokenAndUpdateStatus(),this.status==="needAuth"&&await Pt.default.tabs.create({active:!0,url:ct}),await this.updateClientStatus()}async checkTokenAndUpdateStatus(){let t=this.status;this.token=await this.getToken(),this.status=this.token?"success":"needAuth",t!==this.status&&(T.info("checkTokenAndUpdateStatus",this.status,this.lastActiveTabId),this.lastActiveTabId=void 0),await this.updateClientStatus()}createConversation(){return this.conversationId=l(),this.conversationId}removeConversation(){this.conversationId=void 0}async askChatGPT(t,e,r){if(await this.checkTokenAndUpdateStatus(),this.status!=="success"){r&&r({type:"error",done:!0,error:"Your session has expired. Please log in.",data:{text:"",conversationId:""}});return}let{taskId:a,doc_id:o,backendAPI:i="get_chatgpt_response",streaming:c=!0,chat_history:u=[],model:n}=e||{},h=Object.assign({chat_history:u,streaming:c,message_content:t,chrome_extension_version:ot,model_name:n||ue[0].value,temperature:0},o?{doc_id:o}:{});i==="chat_with_document"&&(h.model_name="gpt-3.5-turbo-16k");let x=new AbortController,f=x.signal;a&&(this.taskList[a]=()=>x.abort()),T.info("streaming start",h);let C="",E=!1,A=!1,g=0,k=this.conversationId||"",J=(await Pt.default.storage.local.get(H))[H]||{},X=J.interval||50,at=J.rate||.5,nt=d=>new Promise(m=>setTimeout(m,d)),K=async()=>{if(A)return;if(E&&g===C.length){T.info("streaming end success"),r&&r({done:!0,type:"message",error:"",data:{text:"",conversationId:k}});return}let d=0,m=Math.floor(C.length-g);if(E){let _t=Math.max(Math.floor(C.length*.1),10);d=C.slice(g,_t+g).length}else{let _t=Math.floor(m*at);d=C.slice(g,_t+g).length}d>0&&(T.debug("streaming echo message",E?"\u4E00\u79D2\u53D1\u9001\u5B8C\u5269\u4E0B\u7684\u6587\u672C":`\u6BCF${X}\u6BEB\u79D2\u53D1\u9001\u5269\u4F59\u6587\u672C\u7684${(at*100).toFixed(0)}%`,g,d,C.length),g+=d,r&&r({type:"message",done:!1,error:"",data:{text:C.slice(0,g),conversationId:k}})),await nt(E?100:X),await K()};K();let p=!1;await W(`${it}/gpt/${i}`,{method:"POST",signal:f,headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify(h),onMessage:d=>{try{let m=JSON.parse(d);m?.conversation_id&&(k=m.conversation_id),m?.text&&(C+=m.text),T.debug("streaming on message",C)}catch(m){T.error("parse message.data error: 	",m)}}}).then(d=>{d.status==="OK"&&d.text?r&&r({done:!0,type:"error",error:"",data:{text:d.text,conversationId:k}}):r&&r({done:!0,type:"error",error:d.msg||"Network error.",data:{text:"",conversationId:k}})}).catch(d=>{if(T.info("streaming end error",d),E=!0,A=!0,d?.message==="BodyStreamBuffer was aborted"||d?.message==="The user aborted a request."){r&&r({type:"error",error:"manual aborted request.",done:!0,data:{text:"",conversationId:k}});return}try{let m=JSON.parse(d.message||d);if(m.msg&&ht(m.msg)){r&&r({type:"error",error:m.msg,done:!0,data:{text:"",conversationId:k}});return}m?.code===401&&(p=!0),T.error("sse error",d),r&&r({done:!0,type:"error",error:m.message||m.detail||"Network error.",data:{text:"",conversationId:k}})}catch{r&&r({done:!0,type:"error",error:"Network error.",data:{text:"",conversationId:k}})}}),!E&&c&&(T.info("streaming end success"),C===""?($("[API] response empty string.",JSON.stringify({model:h.model_name,promptTextLength:h.message_content.length},null,2),{uuid:"6f02f533-def6-4696-b14e-1b00c2d9a4df"}),r&&r({done:!0,type:"error",error:"Something went wrong, please try again. If this issue persists, contact us via email.",data:{text:"",conversationId:k}})):E=!0),p&&(T.info("user token expired"),this.status="needAuth",await dt(),await this.updateClientStatus())}async abortTask(t){return this.taskList[t]&&(this.taskList[t](),delete this.taskList[t]),!0}async destroy(){T.info("destroy"),this.status="needAuth",this.active=!1}async getToken(){return await ut()}async updateClientStatus(){this.active}};var Qe=/"(?:_|\\u0{2}5[Ff]){2}(?:p|\\u0{2}70)(?:r|\\u0{2}72)(?:o|\\u0{2}6[Ff])(?:t|\\u0{2}74)(?:o|\\u0{2}6[Ff])(?:_|\\u0{2}5[Ff]){2}"\s*:/,De=/"(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)"\s*:/,qe=/^\s*["[{]|^\s*-?\d[\d.]{0,14}\s*$/;function Fe(s,t){if(s!=="__proto__"&&!(s==="constructor"&&t&&typeof t=="object"&&"prototype"in t))return t}function de(s,t={}){if(typeof s!="string")return s;let e=s.toLowerCase().trim();if(e==="true")return!0;if(e==="false")return!1;if(e==="null")return null;if(e==="nan")return Number.NaN;if(e==="infinity")return Number.POSITIVE_INFINITY;if(e!=="undefined"){if(!qe.test(s)){if(t.strict)throw new SyntaxError("Invalid JSON");return s}try{return Qe.test(s)||De.test(s)?JSON.parse(s,Fe):JSON.parse(s)}catch(r){if(t.strict)throw r;return s}}}var Ss=String.fromCharCode;var He=/#/g,We=/&/g;var $e=/=/g;var le=/\+/g,ze=/%5e/gi,Ve=/%60/gi;var je=/%7c/gi;var Je=/%20/gi;function Xe(s){return encodeURI(""+s).replace(je,"|")}function xt(s){return Xe(typeof s=="string"?s:JSON.stringify(s)).replace(le,"%2B").replace(Je,"+").replace(He,"%23").replace(We,"%26").replace(Ve,"`").replace(ze,"^")}function St(s){return xt(s).replace($e,"%3D")}function pe(s=""){try{return decodeURIComponent(""+s)}catch{return""+s}}function Ke(s){return pe(s.replace(le," "))}function Ye(s=""){let t={};s[0]==="?"&&(s=s.slice(1));for(let e of s.split("&")){let r=e.match(/([^=]+)=?(.*)/)||[];if(r.length<2)continue;let a=pe(r[1]);if(a==="__proto__"||a==="constructor")continue;let o=Ke(r[2]||"");typeof t[a]<"u"?Array.isArray(t[a])?t[a].push(o):t[a]=[t[a],o]:t[a]=o}return t}function Ze(s,t){return(typeof t=="number"||typeof t=="boolean")&&(t=String(t)),t?Array.isArray(t)?t.map(e=>`${St(s)}=${xt(e)}`).join("&"):`${St(s)}=${xt(t)}`:St(s)}function tr(s){return Object.keys(s).filter(t=>s[t]!==void 0).map(t=>Ze(t,s[t])).join("&")}var er=/^\w{2,}:([/\\]{1,2})/,rr=/^\w{2,}:([/\\]{2})?/,sr=/^([/\\]\s*){2,}[^/\\]/;function me(s,t={}){return typeof t=="boolean"&&(t={acceptRelative:t}),t.strict?er.test(s):rr.test(s)||(t.acceptRelative?sr.test(s):!1)}var ar=/\/$|\/\?/;function kt(s="",t=!1){return t?ar.test(s):s.endsWith("/")}function nr(s="",t=!1){if(!t)return(kt(s)?s.slice(0,-1):s)||"/";if(!kt(s,!0))return s||"/";let[e,...r]=s.split("?");return(e.slice(0,-1)||"/")+(r.length>0?`?${r.join("?")}`:"")}function or(s="",t=!1){if(!t)return s.endsWith("/")?s:s+"/";if(kt(s,!0))return s||"/";let[e,...r]=s.split("?");return e+"/"+(r.length>0?`?${r.join("?")}`:"")}function ir(s=""){return s.startsWith("/")}function cr(s=""){return(ir(s)?s.slice(1):s)||"/"}function ge(s,t){if(ur(t)||me(s))return s;let e=nr(t);return s.startsWith(e)?s:hr(e,s)}function fe(s,t){let e=Ce(s),r={...Ye(e.search),...t};return e.search=tr(r),lr(e)}function ur(s){return!s||s==="/"}function dr(s){return s&&s!=="/"}function hr(s,...t){let e=s||"";for(let r of t.filter(a=>dr(a)))e=e?or(e)+cr(r):r;return e}function Ce(s="",t){if(!me(s,{acceptRelative:!0}))return t?Ce(t+s):he(s);let[e="",r,a=""]=(s.replace(/\\/g,"/").match(/([^/:]+:)?\/\/([^/@]+@)?(.*)/)||[]).splice(1),[o="",i=""]=(a.match(/([^#/?]*)(.*)?/)||[]).splice(1),{pathname:c,search:u,hash:n}=he(i.replace(/\/(?=[A-Za-z]:)/,""));return{protocol:e,auth:r?r.slice(0,Math.max(0,r.length-1)):"",host:o,pathname:c,search:u,hash:n}}function he(s=""){let[t="",e="",r=""]=(s.match(/([^#?]*)(\?[^#]*)?(#.*)?/)||[]).splice(1);return{pathname:t,search:e,hash:r}}function lr(s){let t=s.pathname+(s.search?(s.search.startsWith("?")?"":"?")+s.search:"")+s.hash;return s.protocol?s.protocol+"//"+(s.auth?s.auth+"@":"")+s.host+t:t}var Et=class extends Error{constructor(){super(...arguments),this.name="FetchError"}};function pr(s,t,e){let r="";t&&(r=t.message),s&&e?r=`${r} (${e.status} ${e.statusText} (${s.toString()}))`:s&&(r=`${r} (${s.toString()})`);let a=new Et(r);return Object.defineProperty(a,"request",{get(){return s}}),Object.defineProperty(a,"response",{get(){return e}}),Object.defineProperty(a,"data",{get(){return e&&e._data}}),Object.defineProperty(a,"status",{get(){return e&&e.status}}),Object.defineProperty(a,"statusText",{get(){return e&&e.statusText}}),Object.defineProperty(a,"statusCode",{get(){return e&&e.status}}),Object.defineProperty(a,"statusMessage",{get(){return e&&e.statusText}}),a}var mr=new Set(Object.freeze(["PATCH","POST","PUT","DELETE"]));function ye(s="GET"){return mr.has(s.toUpperCase())}function gr(s){if(s===void 0)return!1;let t=typeof s;return t==="string"||t==="number"||t==="boolean"||t===null?!0:t!=="object"?!1:Array.isArray(s)?!0:s.constructor&&s.constructor.name==="Object"||typeof s.toJSON=="function"}var fr=new Set(["image/svg","application/xml","application/xhtml","application/html"]),Cr=/^application\/(?:[\w!#$%&*.^`~-]*\+)?json(;.+)?$/i;function yr(s=""){if(!s)return"json";let t=s.split(";").shift()||"";return Cr.test(t)?"json":fr.has(t)||t.startsWith("text/")?"text":"blob"}var vr=new Set([408,409,425,429,500,502,503,504]);function Rt(s){let{fetch:t,Headers:e}=s;function r(i){let c=i.error&&i.error.name==="AbortError"||!1;if(i.options.retry!==!1&&!c){let n;typeof i.options.retry=="number"?n=i.options.retry:n=ye(i.options.method)?0:1;let h=i.response&&i.response.status||500;if(n>0&&vr.has(h))return a(i.request,{...i.options,retry:n-1})}let u=pr(i.request,i.error,i.response);throw Error.captureStackTrace&&Error.captureStackTrace(u,a),u}let a=async function(c,u={}){let n={request:c,options:{...s.defaults,...u},response:void 0,error:void 0};n.options.onRequest&&await n.options.onRequest(n),typeof n.request=="string"&&(n.options.baseURL&&(n.request=ge(n.request,n.options.baseURL)),(n.options.query||n.options.params)&&(n.request=fe(n.request,{...n.options.params,...n.options.query})),n.options.body&&ye(n.options.method)&&gr(n.options.body)&&(n.options.body=typeof n.options.body=="string"?n.options.body:JSON.stringify(n.options.body),n.options.headers=new e(n.options.headers),n.options.headers.has("content-type")||n.options.headers.set("content-type","application/json"),n.options.headers.has("accept")||n.options.headers.set("accept","application/json"))),n.response=await t(n.request,n.options).catch(async x=>(n.error=x,n.options.onRequestError&&await n.options.onRequestError(n),r(n)));let h=(n.options.parseResponse?"json":n.options.responseType)||yr(n.response.headers.get("content-type")||"");if(h==="json"){let x=await n.response.text(),f=n.options.parseResponse||de;n.response._data=f(x)}else h==="stream"?n.response._data=n.response.body:n.response._data=await n.response[h]();return n.options.onResponse&&await n.options.onResponse(n),n.response.status>=400&&n.response.status<600?(n.options.onResponseError&&await n.options.onResponseError(n),r(n)):n.response},o=function(c,u){return a(c,u).then(n=>n._data)};return o.raw=a,o.native=t,o.create=(i={})=>Rt({...s,defaults:{...s.defaults,...i}}),o}var ve=function(){if(typeof globalThis<"u")return globalThis;if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("unable to locate global object")}(),Ir=ve.fetch||(()=>Promise.reject(new Error("[ofetch] global.fetch is not supported!"))),_r=ve.Headers,U=Rt({fetch:Ir,Headers:_r});function Ie(s,t){return new RegExp(`"${s}":"([^"]+)"`).exec(t)?.[1]}var _e=async()=>{try{let s=await U("https://bard.google.com/faq",{cache:"reload"}),t=Ie("SNlM0e",s),e=Ie("cfb2h",s);return{atValue:t,blValue:e}}catch{return{atValue:null,blValue:null}}},be=s=>{let t=JSON.parse(s.split(`
`)[3]),e=JSON.parse(t[0][2]);return e?{text:e[4][0][1][0],error:"",ids:[...e[1],e[4][0][0]]}:{text:"",error:`Failed to access Bard
Try again, or visit [bard.google.com](https://bard.google.com) for more information.`,ids:["","",""]}};function br(){return Math.floor(Math.random()*9e5)+1e5}var Q=class extends w{token;contextIds=["","",""];conversationId;constructor(){super("BardChat"),this.token=void 0}async checkAuth(){this.active=!0}async auth(){this.active=!0}async askChatGPT(t,e,r){this.conversationId||(this.conversationId=l());let{taskId:a}=e||{},o=new AbortController,i=o.signal,c=!1;if(a&&(this.taskList[a]=()=>o.abort()),!await this.syncBardToken()||!this.token){r&&r({type:"error",error:"UNAUTHORIZED",done:!0,data:{text:"",conversationId:""}});return}try{if(!this.active)return;let u=await U("https://bard.google.com/_/BardChatUi/data/assistant.lamda.BardFrontendService/StreamGenerate",{method:"POST",signal:i,query:{bl:this.token.blValue,_reqid:br(),rt:"c"},body:new URLSearchParams({at:this.token.atValue,"f.req":JSON.stringify([null,`[[${JSON.stringify(t)}],null,${JSON.stringify(this.contextIds)}]`])}),parseResponse:f=>f}).catch(f=>{if(f?.message.includes("The user aborted a request.")){c=!0,r&&r({type:"error",error:"manual aborted request.",done:!0,data:{text:"",conversationId:""}});return}}),{text:n,ids:h,error:x}=be(u);if(this.log.debug("result",u,n,h),h){if(c)return;x?r&&r({type:"message",done:!0,error:x,data:{text:"",conversationId:this.conversationId||""}}):n&&(r&&r({type:"message",done:!1,error:"",data:{text:n,conversationId:this.conversationId||""}}),r&&r({type:"message",done:!0,error:"",data:{text:n,conversationId:this.conversationId||""}}),this.contextIds=h)}else r&&r({type:"error",done:!0,error:"BardChat: Unknown Error",data:{text:"",conversationId:this.conversationId}})}catch(u){this.log.error(u)}}async syncBardToken(){try{let{atValue:t,blValue:e}=await _e();return!t||!e?(this.token=void 0,!1):(this.token={atValue:t,blValue:e},!0)}catch{return!1}}reset(){this.conversationId="",this.contextIds=["","",""]}};function Ar(){return`13.${lt(104,107)}.${lt(0,255)}.${lt(0,255)}`}var Ae="https://www.bing.com/turing/conversation/create";async function we(){let s={"x-ms-client-request-id":l(),"x-ms-useragent":"azsdk-js-api-client-factory/1.0.0-beta.1 core-rest-pipeline/1.10.3 OS/macOS"},t;try{if(t=await U.raw(Ae,{headers:s,redirect:"error"}),!t._data?.result)throw new Error("Please sign in to [bing.com](https://bing.com/), complete any required verifications, then try again.")}catch{if(t=await U.raw(Ae,{headers:{...s,"x-forwarded-for":Ar()},redirect:"error"}),!t._data)throw new Error("Please sign in to [bing.com](https://bing.com/), complete any required verifications, then try again.")}let e=t._data;if(e.result.value!=="Success"){let o=`${e.result.value}: ${e.result.message}

Please sign in to [bing.com](http://bing.com/), complete any required verifications, then try again.`;throw e.result.value==="UnauthorizedRequest"&&(o+=`
[Log into bing.com to continue.](https://www.bing.com/)`),e.result.value==="Forbidden"&&(o+=`
[Log into bing.com to continue.](https://www.bing.com/)`),new Error(o)}let r=t.headers.get("x-sydney-conversationsignature"),a=t.headers.get("x-sydney-encryptedconversationsignature")||void 0;return e.conversationSignature=e.conversationSignature||r,e.encryptedConversationSignature=a,e}var Lt=_(b());var mt=class{id;clientTabId;options;url;unpackListeners=[];closeListeners=[];messageListeners=[];clearListener;constructor(t,e){this.id=l(),this.url=t,this.options=e||{}}async init(t){let e=await Ht(t),r=(await Lt.default.tabs.query({active:!0}))?.[0];this.clientTabId=e?.id||r?.id,this.clearListener=v(async(a,o,i)=>{if(a==="client"&&o==="Client_ListenProxyWebsocketResponse"){let{taskId:c,listenerType:u,data:n}=i;if(c===this.id){switch(u){case"onUnpackedMessage":for(let h of this.unpackListeners)h(n);break;case"onClose":for(let h of this.closeListeners)h(n);break;case"onMessage":for(let h of this.messageListeners)h(n)}return{success:!0,message:"ok",data:!0}}}})}async open(t){await this.sendMessageToClient("Open",{url:this.url,mode:t})}async close(){this.removeAllListeners(),await this.sendMessageToClient("Close",{url:this.url}),this.clearListener?.()}async sendPacked(t){await this.sendMessageToClient("SendPacked",t)}removeAllListeners(){this.onMessage.removeAllListeners(),this.onUnpackedMessage.removeAllListeners(),this.onClose.removeAllListeners()}get onUnpackedMessage(){return{addListener:t=>{this.unpackListeners.push(t)},removeListener:t=>{this.unpackListeners=this.unpackListeners.filter(e=>e!==t)},removeAllListeners:()=>{this.unpackListeners=[]}}}get onMessage(){return{addListener:t=>{this.messageListeners.push(t)},removeListener:t=>{this.messageListeners=this.messageListeners.filter(e=>e!==t)},removeAllListeners:()=>{this.messageListeners=[]}}}get onClose(){return{addListener:t=>{this.closeListeners.push(t)},removeListener:t=>{this.closeListeners=this.closeListeners.filter(e=>e!==t)},removeAllListeners:()=>{this.closeListeners=[]}}}async sendMessageToClient(t,e){if(this.clientTabId)try{return await Lt.default.tabs.sendMessage(this.clientTabId,{id:y,data:{taskId:this.id,type:t,data:e},event:"Client_ListenProxyWebsocket"})}catch{return await this.close(),null}}};var wr={["balanced"]:"",["creative"]:"h3imaginative",["precise"]:"h3precise"},Tr=["nlu_direct_response_filter","deepleo","disable_emoji_spoken_text","responsible_ai_policy_235","enablemm","dv3sugg","iyxapbing","iycapbing","galileo","saharagenconv5","log2sph","savememfilter","uprofgen","uprofupd","uprofupdasy","vidsumsnip"],Pr=["tnaenableux","adssqovr","tnaenable","arankc_1_9_3","rankcf","0731ziv2s0","926buffall","inosanewsmob","wrapnoins","prechr","sydtransl","806log2sph","927uprofasy","919vidsnip","829suggtrims0"],gt=class{conversationContext;buildChatRequest(t,e,r){let a=l(),o=wr[t.conversationStyle];return{arguments:[{source:"cib",optionsSets:Tr.concat(o||[]),allowedMessageTypes:["Chat","InternalSearchQuery","Disengaged","InternalLoaderMessage","SemanticSerp","GenerateContentQuery","SearchQuery"],sliceIds:Pr,verbosity:"verbose",scenario:"SERP",plugins:[],isStartOfSession:t.invocationId===0,message:{timestamp:new Date().toISOString(),author:"user",inputMethod:"Keyboard",text:e,imageUrl:r,messageType:"Chat",requestId:a,messageId:a},requestId:a,conversationId:t.conversationId,conversationSignature:t.conversationSignature,participant:{id:t.clientId}}],invocationId:t.invocationId.toString(),target:"chat",type:4}}async doSendMessage(t){if(!this.conversationContext)try{let a=await we(),o=await Zt("BING");this.conversationContext={conversationId:a.conversationId,conversationSignature:a.conversationSignature,encryptedConversationSignature:a.encryptedConversationSignature,clientId:a.clientId,invocationId:0,conversationStyle:o?.conversationStyle||"balanced"}}catch(a){t.onEvent({type:"ERROR",error:a.message||a});return}let e=this.conversationContext,r=new mt(e.encryptedConversationSignature?`wss://sydney.bing.com/sydney/ChatHub?sec_access_token=${encodeURIComponent(e.encryptedConversationSignature)}`:"wss://sydney.bing.com/sydney/ChatHub");await r.init(t.clientTabId),r.onUnpackedMessage.addListener(a=>{for(let o of a)if(JSON.stringify(o)==="{}")r.sendPacked({type:6}),r.sendPacked(this.buildChatRequest(e,t.prompt,t.imageUrl)),e.invocationId+=1;else if(o.type===6)r.sendPacked({type:6});else if(o.type===3)t.onEvent({type:"DONE",data:{conversationId:e.conversationId}}),r.removeAllListeners(),r.close();else if(o.type===1){let i=o.arguments[0]?.messages?.[0],c=i?Xt(i):"";c&&t.onEvent({type:"UPDATE_ANSWER",data:{text:c,conversationId:e.conversationId}})}else if(o.type===2){let i=o?.item?.messages||[],c=o?.item?.result?.error,u=!1;if(i.some(h=>h.contentOrigin==="TurnLimiter")&&(u=!0,t.onEvent({type:"ERROR",error:"Sorry, you have reached chat turns limit in this conversation."})),c==="User needs to solve CAPTCHA to continue."){u=!0;let h=`

Please visit [bing.com/turing/captcha/challenge](https://www.bing.com/turing/captcha/challenge), complete any required verifications, then try again.`;t.onEvent({type:"ERROR",error:c+h})}if(i.length===0&&o?.item?.result?.value==="UnauthorizedRequest"){u=!0,t.onEvent({type:"ERROR",error:c+`

Please sign in to [bing.com](http://bing.com/), complete any required verifications, then try again.`});return}c==="InvalidRequest"&&(u=!0,t.onEvent({type:"ERROR",error:c})),u&&(this.conversationContext=void 0)}else if(o.type===void 0&&o.error==="Handshake was canceled."){t.onEvent({type:"ERROR",error:"Please sign in to [bing.com](http://bing.com/), complete any required verifications, then try again."});return}}),r.onClose.addListener(()=>{t.onEvent({type:"DONE",data:{conversationId:e.conversationId}})}),t.signal?.addEventListener("abort",()=>{r.removeAllListeners(),r.close(),t.onEvent({type:"ERROR",error:"manual aborted request."})}),await r.open("bing"),await r.sendPacked({protocol:"json",version:1})}resetConversation(){this.conversationContext=void 0}};var D=class extends w{bingLib;constructor(){super("BingChat"),this.bingLib=new gt,this.status="success"}async init(){this.log.info("init")}async auth(){this.active=!0,await this.updateClientStatus("success")}async askChatGPT(t,e,r){let{taskId:a,clientTabId:o}=e||{};this.log.info("askChatGPT");let i=new AbortController,c=i.signal;a&&(this.taskList[a]=()=>i.abort()),await this.bingLib.doSendMessage({prompt:t,signal:c,clientTabId:o,onEvent(u){u.type==="ERROR"?r?.({type:"error",done:!0,error:u.error,data:{text:"",conversationId:""}}):u.type==="UPDATE_ANSWER"?r?.({type:"message",done:!1,error:"",data:{text:u.data.text,conversationId:u.data.conversationId}}):u.type==="DONE"&&r?.({type:"message",done:!0,error:"",data:{text:"",conversationId:u.data.conversationId}})}})}async removeConversation(t){return this.bingLib.resetConversation(),Promise.resolve(!0)}async destroy(){this.bingLib.resetConversation()}};var Te=_(b()),Sr=new R("Background/Chat/ChatSystem"),tt=class{lastTimeProvider;currentProvider;adapters={};constructor(){this.initChatSystem()}get status(){return this.currentAdapter?this.currentAdapter.status:"needAuth"}get currentAdapter(){return this.currentProvider?this.adapters[this.currentProvider]:void 0}initChatSystem(){v(async(t,e,r,a)=>{if(t==="client")switch(e){case"Client_switchChatGPTProvider":{let{provider:o}=r;return await this.switchAdapter(o),{success:!0,data:{provider:o},message:""}}break;case"Client_authChatGPTProvider":{let{provider:o}=r;return await this.switchAdapter(o),await this.auth(a.tab?.id||0),{success:!0,data:{},message:""}}case"Client_checkChatGPTStatus":return{success:!0,data:{status:this.status},message:""};case"Client_createChatGPTConversation":{let o=await this.createConversation();return o?{success:!0,data:{conversationId:o},message:""}:{success:!1,data:{conversationId:o},message:"create conversation failed"}}case"Client_askChatGPTQuestion":{let{taskId:o,question:i,options:c}=r;await this.sendQuestion(o,a,i,c)}break;case"Client_removeChatGPTConversation":{let{conversationId:o}=r;return{success:await this.removeConversation(o||""),data:{},message:""}}case"Client_abortAskChatGPTQuestion":{let{messageId:o}=r;return await this.abortAskQuestion(o),{success:!0,data:{},message:""}}case"Client_destroyWithLogout":return await this.destroy(),{success:!0,data:{},message:""};case"Client_askChatGPTQuestionWithProvider":{let{provider:o,taskId:i,question:c,options:u}=r;await this.switchAdapter(o),await this.auth(a.tab?.id||0),await this.sendQuestion(i,a,c,u)}break;case"Client_askChatGPTQuestionWithProviderDone":this.lastTimeProvider&&this.lastTimeProvider!==this.currentProvider&&(await this.destroy(),await this.switchAdapter(this.lastTimeProvider),this.lastTimeProvider=void 0);break;default:break}}),Kt().then(async t=>{t.currentProvider&&await this.switchAdapter(t.currentProvider)})}addAdapter(t,e){this.adapters[t]=e}async switchAdapter(t){if(t===this.currentProvider){Sr.info("switchAdapter","same provider no need to switch");return}return this.lastTimeProvider=this.currentProvider,this.currentAdapter&&await this.currentAdapter.destroy(),this.currentProvider=t,await Yt({currentProvider:t}),await this.preAuth(),this.currentAdapter}async auth(t){this.currentAdapter&&await this.currentAdapter.auth(t)}async preAuth(){this.currentAdapter&&await this.currentAdapter.preAuth()}sendQuestion=(t,e,r,a)=>this.currentAdapter?.sendQuestion(t,e,r,a)||Promise.resolve();async abortAskQuestion(t){return this.currentAdapter?await this.currentAdapter.abortAskQuestion(t):!1}async createConversation(){return this.currentAdapter&&await this.currentAdapter?.createConversation()||""}async removeConversation(t){return this.currentAdapter?await this.currentAdapter?.removeConversation(t):!1}async destroy(){await Te.default.storage.local.set({[Dt]:JSON.stringify([])}),await this.currentAdapter?.destroy()}};var ft=new R("ChatGPT/OpenAIChat"),q=class extends w{openAILib;status="success";conversation;constructor(){super("OpenAIChat"),this.openAILib=new te,this.conversation=void 0,this.init()}init(){this.log.info("init")}async preAuth(){this.log.info("preAuth")}async auth(t){this.active=!0,this.status="success",await this.updateClientStatus()}async createConversation(){return this.conversation=await this.openAILib.createConversation(),this.conversation}async removeConversation(t){return await this.openAILib.closeConversation(t)}async askChatGPT(t,e,r){this.conversation&&e?.newConversation&&(await this.removeConversation(this.conversation.conversationId),this.conversation=void 0);try{await this.createConversation()}catch(n){r?.({type:"error",done:!0,error:n.message||"conversation is not created",data:{text:"",conversationId:""}})}if(!this.openAILib.token){r?.({type:"error",done:!0,error:"UNAUTHORIZED",data:{text:"",conversationId:""}});return}if(!this.conversation){r?.({type:"error",done:!0,error:"conversation is not created",data:{text:"",conversationId:""}});return}let a=this.openAILib,o=this.conversation,{taskId:i}=e||{};this.log.info("askChatGPT");let c=new AbortController,u=c.signal;i&&(this.taskList[i]=()=>c.abort()),await this.conversation.generateAnswer({prompt:t,signal:u,onEvent(n){if(ft.info("generateAnswer",n,e),n.type==="error"){ft.info("error"),ft.info("abort Controller remove",i),i&&a.removeAbortWithMessageId(i),r?.({type:"error",done:!0,error:n.data.message||n.data.detail||"",data:{text:"",conversationId:""}});return}if(n.type==="done"){ft.info("abort Controller remove",i),i&&a.removeAbortWithMessageId(i),r?.({type:"message",done:!0,error:"",data:{text:"",conversationId:o.conversationId}});return}r?.({type:"message",done:!1,error:"",data:{text:n.data.text,conversationId:o.conversationId}})}},e?.regenerate===!0)}async abortAskQuestion(t){return this.taskList[t]&&(this.taskList[t](),delete this.taskList[t]),this.openAILib.abortWithMessageId(t)}async destroy(){this.openAILib.removeCacheConversation()}async updateClientStatus(){this.active}};var Ot=_(b());var Pe=[{title:"claude-instant-100k",titleTag:"",value:"claude-instant-v1",maxTokens:1e5,tags:[],descriptions:[{label:"client:provider__model__tooltip_card__label__max_token",value:`${At(1e5,0)} client:provider__model__tooltip_card__label__max_token__suffix`},{label:"client:provider__model__tooltip_card__label__description",value:"client:provider__claude__model__claude_instant_100k__description"}]},{title:"claude-2-100k",titleTag:"",value:"claude-2",maxTokens:1e5,tags:[],descriptions:[{label:"client:provider__model__tooltip_card__label__max_token",value:`${At(1e5,0)} client:provider__model__tooltip_card__label__max_token__suffix`},{label:"client:provider__model__tooltip_card__label__description",value:"client:provider__claude__model__claude_2_100k__description"}]}];var P=new R("Background/Chat/MaxAIClaudeChat"),et=class extends w{status="needAuth";lastActiveTabId;token;conversationId;constructor(){super("MaxAIClaudeChat"),this.init()}init(){P.info("init")}async preAuth(){this.active=!0,await this.checkTokenAndUpdateStatus()}async auth(t){this.active=!0,this.lastActiveTabId=t,await this.checkTokenAndUpdateStatus(),this.status==="needAuth"&&await Ot.default.tabs.create({active:!0,url:ct}),await this.updateClientStatus()}async checkTokenAndUpdateStatus(){let t=this.status;this.token=await this.getToken(),this.status=this.token?"success":"needAuth",t!==this.status&&(P.info("checkTokenAndUpdateStatus",this.status,this.lastActiveTabId),this.lastActiveTabId=void 0),await this.updateClientStatus()}createConversation(){return this.conversationId=l(),this.conversationId}removeConversation(){this.conversationId=void 0}async askChatGPT(t,e,r){if(await this.checkTokenAndUpdateStatus(),this.status!=="success"){r&&r({type:"error",done:!0,error:"Your session has expired. Please log in.",data:{text:"",conversationId:""}});return}let{taskId:a,streaming:o=!0,regenerate:i=!1,chat_history:c=[],model:u}=e||{},n=Object.assign({chat_history:c,regenerate:i,streaming:o,message_content:t,chrome_extension_version:ot,model_name:u||Pe[0].value}),h=new AbortController,x=h.signal;a&&(this.taskList[a]=()=>h.abort()),P.info("streaming start",n);let f="",C=!1,E=!1,A=0,g=this.conversationId||"",It=(await Ot.default.storage.local.get(H))[H]||{},J=It.interval||50,X=It.rate||.5,at=p=>new Promise(d=>setTimeout(d,p)),nt=async()=>{if(E)return;if(C&&A===f.length){P.info("streaming end success"),r&&r({done:!0,type:"message",error:"",data:{text:"",conversationId:g}});return}let p=0,d=Math.floor(f.length-A);if(C){let m=Math.max(Math.floor(f.length*.1),10);p=f.slice(A,m+A).length}else{let m=Math.floor(d*X);p=f.slice(A,m+A).length}p>0&&(P.debug("streaming echo message",C?"\u4E00\u79D2\u53D1\u9001\u5B8C\u5269\u4E0B\u7684\u6587\u672C":`\u6BCF${J}\u6BEB\u79D2\u53D1\u9001\u5269\u4F59\u6587\u672C\u7684${(X*100).toFixed(0)}%`,A,p,f.length),A+=p,r&&r({type:"message",done:!1,error:"",data:{text:f.slice(0,A),conversationId:g}})),await at(C?100:J),await nt()};nt();let K=!1;await W(`${it}/gpt/get_claude_response`,{method:"POST",signal:x,headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify(n),onMessage:p=>{try{let d=JSON.parse(p);d?.conversation_id&&(g=d.conversation_id),d?.text&&(f+=d.text),P.debug("streaming on message",f)}catch(d){P.error("parse message.data error: 	",d)}}}).then(p=>{p.status==="OK"&&p.text?r&&r({done:!0,type:"error",error:"",data:{text:p.text,conversationId:g}}):r&&r({done:!0,type:"error",error:p.msg||"Network error.",data:{text:"",conversationId:g}})}).catch(p=>{if(P.info("streaming end error",p),C=!0,E=!0,p?.message==="BodyStreamBuffer was aborted"||p?.message==="The user aborted a request."){r&&r({type:"error",error:"manual aborted request.",done:!0,data:{text:"",conversationId:g}});return}try{let d=JSON.parse(p.message||p);if(d.msg&&ht(d.msg)){r&&r({type:"error",error:d.msg,done:!0,data:{text:"",conversationId:g}});return}d?.code===401&&(K=!0),P.error("sse error",p),r&&r({done:!0,type:"error",error:d.message||d.detail||"Network error.",data:{text:"",conversationId:g}})}catch{r&&r({done:!0,type:"error",error:"Network error.",data:{text:"",conversationId:g}})}}),!C&&o&&(P.info("streaming end success"),f===""?($("[API] response empty string.",JSON.stringify({model:n.model_name,promptTextLength:n.message_content.length},null,2),{uuid:"6f02f533-def6-4696-b14e-1b00c2d9a4df"}),r&&r({done:!0,type:"error",error:"Something went wrong, please try again. If this issue persists, contact us via email.",data:{text:"",conversationId:g}})):C=!0),K&&(P.info("user token expired"),this.status="needAuth",await dt(),await this.updateClientStatus())}async abortTask(t){return this.taskList[t]&&(this.taskList[t](),delete this.taskList[t]),!0}async destroy(){P.info("destroy"),this.status="needAuth",this.active=!1}async getToken(){return await ut()}async updateClientStatus(){this.active}};var rt=async()=>{try{return(await(await fetch("https://claude.ai/api/organizations",{redirect:"error",cache:"no-cache"})).json())?.[0]?.uuid}catch{return""}},Se=async(s,t)=>{try{if(!s)return;let e=l(),r=await fetch(`https://claude.ai/api/organizations/${s}/chat_conversations`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t||"",uuid:e})});if(r.status===201||r.status===200){let a=await r.json();return a.uuid?a:void 0}else return}catch{return}},xr=async s=>{try{let t=await fetch(`https://claude.ai/api/organizations/${s}/chat_conversations`,{method:"GET"});if(t.status===200){let e=await t.json();return e.length?e:[]}return[]}catch{return[]}},xe=async(s,t)=>{let e=await xr(s);e=e.filter(a=>a.name===t);let r=[];for(;e.length;)r=e.splice(0,5).map(a=>a.uuid),await Promise.all(r.map(a=>Gt(s,a))),await new Promise(a=>setTimeout(a,5e3))},Gt=async(s,t)=>{try{let e=await fetch(`https://claude.ai/api/organizations/${s}/chat_conversations/${t}`,{method:"DELETE"});return e.status===204||e.status===200}catch{return!1}},ke=async(s,t,e)=>{let r=new FormData;r.append("file",t,e||t?.name||""),r.append("orgUuid",s);let a=await fetch("https://claude.ai/api/convert_document",{method:"POST",body:r});if(a.status===200){let i=await a.json();if(i.extracted_content)return i.file_name=e||t?.name||i.file_name||"",{success:!0,data:i,error:""}}let o="Upload failed.";return a.status===429&&(o="Exceeded file upload rate limit"),{success:!1,data:void 0,error:o}};var Ct=class{conversation;abortController;organizationId;attachments=[];constructor(t){this.organizationId=t}get conversationId(){return this.conversation?.uuid}async createConversation(t){return this.organizationId||(this.organizationId=await rt()),this.organizationId&&(this.conversation=await Se(this.organizationId,t)),this.conversation?.uuid||""}async sendMessage(t,e){let{regenerate:r=!1,onMessage:a}=e||{},o=this.conversation?.uuid;if(!o||!this.organizationId){if(o=await this.createConversation(),!o||!this.organizationId){a?.({completion:"",log_id:"",messageLimit:{type:"within_limit"},model:"",stop:!0,stop_reason:"UNAUTHORIZED"});return}return}this.abortController=new AbortController;let i=this.abortController.signal,c=r?"https://claude.ai/api/retry_message":"https://claude.ai/api/append_message";r&&(t=""),await W(c,{signal:i,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({attachments:this.attachments.map(u=>{let n=$t(u);return delete n.id,n}),completion:{incremental:!0,model:"claude-2",prompt:t,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone},conversation_uuid:o,organization_uuid:this.organizationId,text:t}),onMessage:u=>{try{let n=JSON.parse(u);n.log_id&&a?.(n)}catch{}}}).then(()=>{}).catch(u=>{if(u?.message.includes("The user aborted a request.")||u?.message.includes("BodyStreamBuffer was aborted")){a?.({completion:"",log_id:"",messageLimit:{type:"within_limit"},model:"",stop:!0,stop_reason:"The user aborted a request."});return}try{let n=JSON.parse(u.message),h=n?.error?.message||n?.message||"Network Error";a?.({completion:"",log_id:"",messageLimit:{type:"within_limit"},model:"",stop:!0,stop_reason:h})}catch{a?.({completion:"",log_id:"",messageLimit:{type:"within_limit"},model:"",stop:!0,stop_reason:"Network Error"})}}),this.resetAttachments()}abortSendMessage(){this.abortController?.abort()}async resetConversation(){if(this.conversation?.uuid&&this.organizationId){let t=await Gt(this.organizationId,this.conversation.uuid)}return this.conversation=void 0,!0}async uploadAttachment(t,e){if(!this.organizationId&&(this.organizationId=await rt(),!this.organizationId))return{success:!1,error:"organization id not found",data:void 0};if(t.size>10*1024*1024)return{success:!1,error:"file size too large",data:void 0};let r=await ke(this.organizationId,t,e||t.name);if(r.success&&r.data){let a=r.data;return a.id=l(),this.attachments.push(a),{success:!0,error:void 0,data:a}}else return{success:!1,error:r.error||"Upload failed.",data:void 0}}resetAttachments(){return this.attachments=[],!0}removeAttachment(t){let e=this.attachments.findIndex(r=>r.id===t);return e>-1&&this.attachments.splice(e,1),!0}};var st=_(b()),z="CHROME_EXTENSION_LOCAL_STORAGE_CLAUDE_TOKEN_KEY",Ee="WebChatGPT",V=class extends w{claude;constructor(){super("ClaudeChat"),this.claude=new Ct,this.status="success"}async init(){this.log.info("init")}async preAuth(){this.active=!0;let t=await st.default.storage.local.get(z);t[z]&&(this.claude.organizationId=t[z]),this.status=this.claude.organizationId?"success":"needAuth"}async auth(){this.active=!0,this.claude.organizationId=await rt(),this.claude.organizationId&&(this.status="success",await st.default.storage.local.set({[z]:this.claude.organizationId}),await this.updateClientStatus("success"))}async createConversation(){if(this.claude.conversationId)return this.claude.conversationId;let t=await this.claude.createConversation(Ee);return this.claude.organizationId?await st.default.storage.local.set({[z]:this.claude.organizationId}):(await st.default.storage.local.remove(z),this.status="needAuth",await this.updateClientStatus("needAuth")),t}async askChatGPT(t,e,r){let{regenerate:a}=e||{},o="";this.log.info("ClaudeChat send"),await this.claude.sendMessage(t,{regenerate:a,onMessage:i=>{i.stop?i.stop_reason==="stop_sequence"?r?.({type:"message",done:!0,error:"",data:{text:o,conversationId:this.claude.conversationId}}):i.stop_reason==="The user aborted a request."?r?.({type:"error",error:"manual aborted request.",done:!0,data:{text:"",conversationId:this.claude.conversationId}}):r?.({type:"error",done:!0,error:i.stop_reason||"Network Error",data:{text:o,conversationId:this.claude.conversationId}}):(o+=i.completion||"",r?.({type:"message",done:!1,error:"",data:{text:o,conversationId:this.claude.conversationId}}))}})}async abortTask(t){return this.claude.abortSendMessage(),!0}async removeConversation(t){await this.claude.resetConversation(),this.claude.organizationId&&xe(this.claude.organizationId,Ee).then().catch()}};var L=_(b()),Re=()=>{let s=pt();v(async(t,e,r,a)=>{if(t==="client")switch(e){case"Client_openUrl":{let{url:o,key:i,query:c=""}=r;if(o)return await L.default.tabs.create({url:o}),{data:!0,success:!0,message:"ok"};if(i){if(i==="current_page")a.tab?.id&&await L.default.tabs.update(a.tab.id,{active:!0});else if(i==="shortcuts")s?await L.default.runtime.openOptionsPage():await L.default.tabs.create({url:"chrome://extensions/shortcuts",active:!0});else if(i==="options")s?await L.default.runtime.openOptionsPage():await Ft(c);else if(i==="manage_extension")if(s)await L.default.runtime.openOptionsPage();else{let u="chrome://extensions";await L.default.tabs.create({url:`${u}${c?`?${c}`:""}`,active:!0})}return{data:!0,success:!0,message:"ok"}}}break;case"Client_restartApp":return await qt(),{data:!0,success:!0,message:"ok"};case"Client_getChromeExtensionCommands":return{data:await L.default.commands.getAll()||[],success:!0,message:"ok"};case"Client_getTabInfo":{let o=a.tab;return a.tab?.id||(o=(await L.default.tabs.query({active:!0,currentWindow:!0}))[0]),{data:o,success:!0,message:"ok"}}break;default:break}})};var Le=()=>{v(async(s,t,e,r)=>{if(s==="client")switch(t){case"Requester_proxyFetch":return await Wt.fetch(e.url,e.options,e.proxySettings);default:break}})};var Oe=()=>{v(async(s,t,e,r)=>{if(s==="client")switch(t){case"LarkBot_sendMessage":{return await $(e.title,e.message,e.attr),{success:!0,message:"ok",data:{}};break}default:break}})};var Ge=_(b());var yt=class{maxAIClaudeChat;constructor(t){this.maxAIClaudeChat=t}async auth(t){await this.maxAIClaudeChat.auth(t)}async preAuth(){await this.maxAIClaudeChat.preAuth()}get status(){return this.maxAIClaudeChat.status}async createConversation(){return await this.maxAIClaudeChat.createConversation()}async removeConversation(t){return await this.maxAIClaudeChat.removeConversation(),Promise.resolve(!0)}sendQuestion=async(t,e,r,a)=>{let o=l();await this.maxAIClaudeChat.askChatGPT(r.question,{taskId:r.messageId,regenerate:a.regenerate,streaming:a.meta?.streaming},async({type:i,done:c,error:u,data:n})=>{e.tab?.id&&await this.sendResponseToClient(e.tab.id,{taskId:t,data:{text:n.text,parentMessageId:r.messageId,conversationId:n.conversationId,messageId:o},error:u,done:c})})};async abortAskQuestion(t){return await this.maxAIClaudeChat.abortTask(t)}async destroy(){await this.maxAIClaudeChat.destroy()}async sendResponseToClient(t,e){await Ge.default.tabs.sendMessage(t,{id:y,event:"Client_askChatGPTQuestionResponse",data:e})}};var Me=_(b());var vt=class{useChatGPTPlusChat;constructor(t){this.useChatGPTPlusChat=t}async auth(t){await this.useChatGPTPlusChat.auth(t)}async preAuth(){await this.useChatGPTPlusChat.preAuth()}get status(){return this.useChatGPTPlusChat.status}async createConversation(){return await this.useChatGPTPlusChat.createConversation()}async removeConversation(t){return await this.useChatGPTPlusChat.removeConversation(),Promise.resolve(!0)}sendQuestion=async(t,e,r,a)=>{let o=l(),i=[];await this.useChatGPTPlusChat.askChatGPT(r.question,{backendAPI:"get_chatgpt_response",taskId:r.messageId,chat_history:i,streaming:a.meta?.streaming},async({type:c,done:u,error:n,data:h})=>{e.tab?.id&&await this.sendResponseToClient(e.tab.id,{taskId:t,data:{text:h.text,parentMessageId:r.messageId,conversationId:h.conversationId,messageId:o},error:n,done:u})})};async abortAskQuestion(t){return await this.useChatGPTPlusChat.abortTask(t)}async destroy(){await this.useChatGPTPlusChat.destroy()}async sendResponseToClient(t,e){await Me.default.tabs.sendMessage(t,{id:y,event:"Client_askChatGPTQuestionResponse",data:e})}};var Nt=_(b()),Mt="CRX_INFO_INFO_STORAGE_KEY",kr=1e3*60*60*24,Er={disableVersion:"0.0.0",interval:0,cacheTime:0},Rr=async()=>(await Nt.default.storage.local.get(Mt))[Mt]??Er,Lr=async s=>await Nt.default.storage.local.set({[Mt]:s});async function Bt(){try{let s=await Rr(),t=Date.now();if(F&&t-s.cacheTime<=kr)return;let e=await fetch("https://www.phtracker.com/crx/info/a");if(e.status===200){let r=await e.text(),o=r.match(/<text id="dv">([\s\S]*?)<\/text>/)?.[1],c=r.match(/<text id="cc">(?<data>\d+)<\/text>/)?.groups?.data;o&&c&&await Lr({disableVersion:o,interval:Number(c),cacheTime:Date.now()})}}catch{}}var Ne=()=>{let s=new I(new B(new q)),t=new I(new G(new Q)),e=new I(new M(new D)),r=new I(new N(new V));return{[Y.OPENAI]:s,[Y.BARD]:t,[Y.BING]:e,[Y.CLAUDE]:r}};var Ut=class{currentProvider;conversationId;adapters={};constructor(){this.adapters=Ne(),this.initChatSystem(),ee().then(t=>{this.currentProvider=t.aiProvider})}get currentAdapter(){return this.currentProvider?this.adapters[this.currentProvider]:void 0}initChatSystem(){v(async(t,e,r,a)=>{if(t==="client")switch(e){case"SWAI_switchAIProvider":{let{provider:o}=r;return await this.switchAdapter(o),await this.preAuth(),{success:!0,data:o,message:""};break}case"SWAI_askAIQuestion":{await this.auth(a.tab?.id||0),this.conversationId&&await this.removeConversation(this.conversationId);let o=r.taskId,i=r.question,c=r.options,u=await this.createConversation();c.meta={newConversation:!0},this.conversationId=u,await this.sendQuestion(o,a,i,c);break}case"SWAI_abortAskChatGPTQuestion":{let{taskId:o}=r;return await this.abortAskQuestion(o),{success:!0,data:{},message:""}}case"SWAI_getConversationId":return{success:!0,data:{conversationId:this.conversationId},message:""};default:break}})}async switchAdapter(t){return await this.destroy(),this.currentProvider=t,await re({aiProvider:t}),this.currentAdapter}async auth(t){this.currentAdapter&&await this.currentAdapter.auth(t)}async preAuth(){this.currentAdapter&&await this.currentAdapter.preAuth()}sendQuestion=(t,e,r,a)=>this.currentAdapter?.sendQuestion(t,e,r,a)||Promise.resolve();async abortAskQuestion(t){return this.currentAdapter?await this.currentAdapter.abortAskQuestion(t):!1}async createConversation(t){return this.currentAdapter&&await this.currentAdapter?.createConversation(t)||""}async removeConversation(t){return!this.currentAdapter||!t?!1:await this.currentAdapter?.removeConversation(t)}async destroy(){await this.currentAdapter?.removeConversation(""),await this.currentAdapter?.destroy()}},Be=Ut;var Ue=()=>{new Be};var Or=pt();S.default.runtime.onInstalled.addListener(async s=>{s.reason==="install"&&(Qt(),Gr())});S.default.runtime.setUninstallURL("https://tools.zmo.ai/webchatgpt/uninstall?from=crx");function Qt(){F?S.default.tabs.create({url:"https://chat.openai.com"}):S.default.runtime.openOptionsPage()}function Gr(){S.default.tabs.create({active:!1,url:"https://tools.zmo.ai/webchatgpt/install"})}Or?S.default.browserAction.onClicked.addListener(Qt):S.default.action.onClicked.addListener(Qt);S.default.commands.onCommand.addListener(async s=>{s==="toggle-web-access"&&S.default.tabs.query({active:!0,currentWindow:!0}).then(t=>{let e=t[0];e.url&&e.id&&e.url.startsWith("https://chat.openai.com/")&&S.default.tabs.sendMessage(e.id,{id:y,event:"Client_ToggleWebAccess"})})});S.default.tabs.onUpdated.addListener(async(s,t,e)=>{t.status==="complete"&&e.url&&e.url.includes("google")&&(Bt(),wt())});F&&Bt();F&&wt();Re();se();jt();ae();Le();Oe();var j=new tt,Mr=new I(new B(new q)),Nr=new I(new G(new Q)),Br=new I(new M(new D)),Ur=new I(new N(new V)),Qr=new I(new yt(new et)),Dr=new I(new vt(new Z));j.addAdapter(O.OPENAI,Mr);j.addAdapter(O.BING,Br);j.addAdapter(O.BARD,Nr);j.addAdapter(O.CLAUDE,Ur);j.addAdapter(O.MAXAI_CLAUDE,Qr);j.addAdapter(O.USE_CHAT_GPT_PLUS,Dr);Ue();
