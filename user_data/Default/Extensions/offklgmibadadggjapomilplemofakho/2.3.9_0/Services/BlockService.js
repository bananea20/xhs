!function(t,h){"use strict";var c=t,f=h.EventNotifier,R=h.EventNotifierTypes,a=h.CollectionUtils,s=c.FilterLSUtils;t.BlockService=function(){this.yiclearFilters=[],this.requestFilter=new c.RequestFilter,this.ApplicationUpdateService=c.ApplicationUpdateService,this.subscriptionService=new c.SubscriptionService,this.filterClasses=c.filterClasses,this.userRules=[],this.userFilterAutoRules=[],this.applicationFilteringDisabled=c.userSettings.isFilteringDisabled(),this._requestFilterInitTime=0,this._processFilterEvent=null},t.FilterVersion=function(e,t,i){this.timeUpdated=e,this.version=t,this.filterId=i},t.BlockService.prototype={FILTERS_CHANGE_DEBOUCE_PERIOD:1e3,RELOAD_FILTERS_DEBOUNCE_PERIOD:1e3,contentBlockerInfo:{rulesCount:0,rulesOverLimit:!1},_addAndEnableFilters:function(e,i){i=i||function(){};var r=[];if(e&&0!==e.length){var n=function(){if(0===e.length)i(r);else{var t=e.shift();this.addAntiBannerFilter(t,function(e){e&&this.enableAntiBannerFilter(t)&&r.push(t);n()}.bind(this))}}.bind(this);n()}else i(r)},addAntiBannerFilter:function(e,t){var i=this._getFilterById(e);if(i.installed)t(!0);else{var r=function(e){e&&(i.installed=!0,s.updateFilterStateInfo(i),f.notifyListeners(R.ADD_FILTER,i)),t(e)};i.loaded?r(!0):this._loadFilterFromBackend(e,r)}},_getFilterById:function(e){for(var t=0;t<this.yiclearFilters.length;t++){var i=this.yiclearFilters[t];if(i.filterId==e)return i}throw"Filter with id "+e+" not found"},_setFilterById:function(e){for(var t=0;t<this.yiclearFilters.length;t++){if(this.yiclearFilters[t].filterId==e.filterId)return this.yiclearFilters[t]=e,!0}return!1},_loadFilterFromBackend:function(e,i){var r=h.Log,n=this._getFilterById(e);n._isDownloading=!0,f.notifyListeners(R.START_DOWNLOAD_FILTER,n);var t=function(e){r.info("Retrieved response from server for filter {0}, rules count: {1}",n.filterId,e.length),delete n._isDownloading,n.lastUpdateTime=(new Date).getTime(),n.lastCheckTime=Date.now(),n.loaded=!0,s.updateFilterStateInfo(n),s.updateFilterVersionInfo(n),f.notifyListeners(R.SUCCESS_DOWNLOAD_FILTER,n),f.notifyListeners(R.UPDATE_FILTER_RULES,n,e),i(!0)}.bind(this);this.subscriptionService.serviceClient.loadFilterRules(n.subscriptionUrl,c.userSettings.isUseOptimizedFiltersEnabled(),t,function(e,t){r.error("Error retrieved response from server for filter {0}, cause: {1} {2}",n.filterId,e.statusText,t||""),delete n._isDownloading,f.notifyListeners(R.ERROR_DOWNLOAD_FILTER,n),i(!1)})},enableAntiBannerFilter:function(e){var t=this._getFilterById(e);return!(t.enabled||!t.installed)&&(!t.enabled&&(t.enabled=!0,s.updateFilterStateInfo(t),f.notifyListeners(R.ENABLE_FILTER,t),!0))},removeAntiBannerFilter:function(e){var t=this._getFilterById(e);return"111"!=e&&(t.enabled=!1,t.installed=!1,s.updateFilterStateInfo(t),!!this._setFilterById(t)&&(f.notifyListeners(R.DISABLE_FILTER,t),f.notifyListeners(R.REMOVE_FILTER,t),!0))},disableAntiBannerFilter:function(e){var t=this._getFilterById(e);return!!t.enabled&&(t.enabled=!1,s.updateFilterStateInfo(t),f.notifyListeners(R.DISABLE_FILTER,t),!0)},initializeFiltersOnInstall:function(i){var e=function(e){for(var t in this.yiclearFilters=this.filterClasses.getAllyiclearFilters(this.subscriptionService),this.yiclearFilters)111===this.yiclearFilters[t].filterId&&(this.yiclearFilters[t].enabled=!1,this.yiclearFilters[t].installed=!0,this.yiclearFilters[t].lastUpdateTime=(new Date).getTime(),this.yiclearFilters[t].RuleCount=e,this._addFiltersChangeEventListener(),this.enableAntiBannerFilter(this.yiclearFilters[t].filterId),i(this.yiclearFilters[t].filterId))}.bind(this);(function(){0===this.subscriptionService.getGroups().length||(t.userSettings.setProperty(t.userSettings.settings.DISABLE_AUTOUPDATE,!1),t.userSettings.setProperty(t.userSettings.settings.DISABLE_DEVELOPER,!1),t.userSettings.setProperty(t.userSettings.settings.DISABLE_SHOW_YOUKU_DANMU,!0),t.userSettings.setProperty(t.userSettings.settings.DISABLE_UPDATE_FIRSTRUN,!1),this.subscriptionService.getremoteFilterRule(e))}).bind(this)()},_createRequestFilter:function(e){var t=h.Log,i=(new Date).getTime();t.info("Starting loading filter rules from the storage");function r(t,i){var r=new h.vPromise;return c.FilterStorage.loadFilterRules(t,function(e){e&&(i[t]=e),r.resolve()}),r}var n=Object.create(null),s=function(){t.info("Finished loading filter rules from the storage in {0} ms",(new Date).getTime()-i),this._onFiltersLoadedFromStorage(n,e)}.bind(this);(function(){for(var e=[],t=0;t<this.yiclearFilters.length;t++){var i=this.yiclearFilters[t];i.enabled&&e.push(r(i.filterId,n))}e.push(this._loadUserRulesToRequestFilter(n)),e.push(this._loadUserAutoRulesToRequestFilter(n)),h.vPromise.all(e).then(s)}).bind(this)()},_loadUserRulesToRequestFilter:function(t){var i=new h.vPromise,r=h.AntiBannerFiltersId.USER_FILTER_ID;return c.FilterStorage.loadFilterRules(r,function(e){this.userRules=e||[],e&&(t[r]=e),i.resolve()}.bind(this)),i},_loadUserAutoRulesToRequestFilter:function(t){var i=new h.vPromise,r=h.AntiBannerFiltersId.USER_FILTER_AUTO_ID;return c.FilterStorage.loadFilterRules(r,function(e){this.userFilterAutoRules=e||[],e&&(t[r]=e),i.resolve()}.bind(this)),i},_onFiltersLoadedFromStorage:function(u,e){var t=h.Log,i=(new Date).getTime(),r=c.Prefs.speedupStartup();t.info("Starting request filter initialization. Async={0}",r);function l(e,t,i,r){var n=c.FilterRuleBuilder;if(t)for(var s=i;s<t.length&&s<r;s++){var l=t[s],u=n.createRule(l,e);null!==u&&a.addRule(u)}}function o(e,t,i,r,n){var s=new h.vPromise;return n.then(function(){setTimeout(function(){l(e,t,i,r),s.resolve()},1)}),s}var a=new c.RequestFilter,F=(Object.create(null),function(){this.requestFilter=a,e&&"function"==typeof e&&e(),f.notifyListeners(R.REQUEST_FILTER_UPDATED,this.getRequestFilterInfo()),t.info("Finished request filter initialization in {0} ms. Rules count: {1}",(new Date).getTime()-i,a.rulesCount),0!==a.rulesCount||this.reloadedRules?0<a.rulesCount&&this.reloadedRules&&(t.info("Filters reloaded, deleting reloadRules flag"),delete this.reloadedRules):(t.info("No rules have been found - checking filter updates"),this._reloadAntiBannerFilters(),this.reloadedRules=!0)}.bind(this));r?function(){var e=new h.vPromise,t=null,i=[];for(var r in u)if((r-=0)!=h.AntiBannerFiltersId.USER_FILTER_ID)for(var n=u[r],s=0;s<n.length;s+=1e3)t=o(r,n,s,s+1e3,t||e),i.push(t);var l=u[h.AntiBannerFiltersId.USER_FILTER_ID];o(h.AntiBannerFiltersId.USER_FILTER_ID,l,0,l.length,t||e),h.vPromise.all(i).then(function(){F()}),e.resolve()}():function(){for(var e in u)if((e-=0)!=h.AntiBannerFiltersId.USER_FILTER_ID){var t=u[e];l(e,t,0,t.length)}var i=u[h.AntiBannerFiltersId.USER_FILTER_ID];l(h.AntiBannerFiltersId.USER_FILTER_ID,i,0,i.length),F()}()},getRequestFilterInfo:function(){for(var e=0,t=0,i=0,r=[],n=0;n<this.yiclearFilters.length;n++)this.yiclearFilters[n].enabled&&r.push(this.yiclearFilters[n]);return this.requestFilter&&(i=(e=this.requestFilter.rulesCount)-(t=this.requestFilter.cssFilter.commonRules.length+this.requestFilter.cssFilter.exceptionRules.length+this.requestFilter.cssFilter.domainSensitiveRules.length)),{enabledFilters:r,rulesCount:e,cssCount:t,urlCount:i}},updateContentBlockerInfo:function(e){this.contentBlockerInfo.rulesCount=e.rulesCount,this.contentBlockerInfo.rulesOverLimit=e.rulesOverLimit},modifyfiltertitle:function(e,t){var i=this._getFilterById(e);i.nickname=t;for(var r=2;r<this.yiclearFilters.length;r++)this.yiclearFilters[r].filterId==e&&(this.yiclearFilters[r].nickname=t);f.notifyListeners(R.MODIFY_FILTER,i),this.subscriptionService.updateFilterInfo(i)},isAntiBannerFilterEnabled:function(e){return this._getFilterById(e).enabled},getContentBlockerInfo:function(){return this.contentBlockerInfo},getFiltersMetadata:function(){for(var e=[],t=2;t<this.yiclearFilters.length;t++)e.push(this.yiclearFilters[t]);return e},_getUserFilterRule:function(e,t){for(var i=2;i<this.yiclearFilters.length;i++)if(this.yiclearFilters[i].subscriptionUrl==e){var r=this.yiclearFilters[i];return this.yiclearFilters[i].enabled=!1,this.yiclearFilters[i].installed=!0,r=this.yiclearFilters[i],f.notifyListeners(R.ADD_FILTER,r),f.notifyListeners(R.DISABLE_FILTER,r),this.enableAntiBannerFilter(r.filterId),void(t&&t(r))}this.subscriptionService.getUserFilterRule(e,function(e){if(e){if(!e.filterId)return t&&t("订阅组下载超时!"),void f.notifyListeners(R.ERROR_DOWNLOAD_FILTER,e);f.notifyListeners(R.ADD_FILTER,e),this.yiclearFilters.push(e),this.enableAntiBannerFilter(e.filterId),t&&t(r)}}.bind(this))},_autoUpdateFilterUrl:function(e,t){this.subscriptionService.updateFilterInfo(e),this._updateFilterUrl(e.filterId,function(){e.version=t,this.subscriptionService.updateFilterInfo(e)}.bind(this))},_updateFilterUrl:function(s,l){this.subscriptionService.updateFilterUrl(s,function(e){for(var t=0;t<this.yiclearFilters.length;t++)if(this.yiclearFilters[t].filterId==Number(s)){this.yiclearFilters[t].lastUpdateTime=e;for(var i=this.subscriptionService.getGroups(),r=0;r<i.length;r++)i[r].filterId==Number(this.yiclearFilters[t].filterId)&&(this.yiclearFilters[t].RuleCount=i[r].RuleCount,this.yiclearFilters[t].name=i[r].name||i[r].title||i[r].nickname)}var n=this._getFilterById(s);f.notifyListeners(R.SUCCESS_DOWNLOAD_FILTER,n),n.enabled=!1,f.notifyListeners(R.DISABLE_FILTER,n),n.enabled=!0,f.notifyListeners(R.ENABLE_FILTER,n),l(e)}.bind(this))},getEnabledAntiBannerFilters:function(){return this.yiclearFilters.filter(function(e){return e.installed&&e.enabled&&e.filterId!=h.AntiBannerFiltersId.USER_FILTER_ID&&e.filterId!=h.AntiBannerFiltersId.WHITE_LIST_FILTER_ID})},addAndEnableFilter:function(e){this._addAndEnableFilters([e])},addUserFilterAutoRule:function(t){var e=c.FilterRuleBuilder;if(0<this.userFilterAutoRules.length&&0!==this.userFilterAutoRules.filter(function(e){return e===t}).length)return;var i=e.createRule(t,h.AntiBannerFiltersId.USER_FILTER_AUTO_ID);null!==i&&i.domain&&(this._addRuleToFilter(h.AntiBannerFiltersId.USER_FILTER_AUTO_ID,i),this.userFilterAutoRules.push(i.ruleText)),f.notifyListeners(R.UPDATE_USER_FILTER_AUTO_RULES,this.getRequestFilterInfo())},addUserFilterAutoRules:function(t){for(var e=c.FilterRuleBuilder,i=[],r=0;r<t.length;r++){if(0<this.userRules.length)if(0!==this.userRules.filter(function(e){return e===t[r]}).length)continue;var n=e.createRule(t[r],h.AntiBannerFiltersId.USER_FILTER_AUTO_ID);null!==n&&(i.push(n),this.userFilterAutoRules.push(n.ruleText))}this._addRulesToFilter(h.AntiBannerFiltersId.USER_FILTER_AUTO_ID,i),f.notifyListeners(R.UPDATE_USER_FILTER_AUTO_RULES,this.getRequestFilterInfo())},addUserFilterRule:function(t){var e=c.FilterRuleBuilder;if(0<this.userRules.length&&0!==this.userRules.filter(function(e){return e===t}).length)return;var i=e.createRule(t,h.AntiBannerFiltersId.USER_FILTER_ID);null!==i&&(this._addRuleToFilter(h.AntiBannerFiltersId.USER_FILTER_ID,i),this.userRules.push(i.ruleText)),f.notifyListeners(R.UPDATE_USER_FILTER_RULES,this.getRequestFilterInfo())},addUserFilterRules:function(t){for(var e=c.FilterRuleBuilder,i=[],r=0;r<t.length;r++){if(0<this.userRules.length)if(0!==this.userRules.filter(function(e){return e===t[r]}).length)continue;var n=e.createRule(t[r],h.AntiBannerFiltersId.USER_FILTER_ID);null!==n&&(i.push(n),this.userRules.push(n.ruleText))}return this._addRulesToFilter(h.AntiBannerFiltersId.USER_FILTER_ID,i),f.notifyListeners(R.UPDATE_USER_FILTER_RULES,this.getRequestFilterInfo()),i},_addRuleToFilter:function(e,t){var i=this._getFilterById(e);this.requestFilter.addRule(t),f.notifyListeners(R.ADD_RULE,i,[t])},_addRulesToFilter:function(e,t){var i=this._getFilterById(e);this.requestFilter.addRules(t),f.notifyListeners(R.ADD_RULES,i,t)},removeUserFilterAutoRule:function(e){var t=c.FilterRuleBuilder.createRule(e,h.AntiBannerFiltersId.USER_FILTER_AUTO_ID);if(null!==t){var i=this._getFilterById(h.AntiBannerFiltersId.USER_FILTER_AUTO_ID);this.requestFilter.removeRule(t),f.notifyListeners(R.REMOVE_RULE,i,[t])}a.removeAll(this.userFilterAutoRules,e),f.notifyListeners(R.UPDATE_USER_FILTER_AUTO_RULES,this.getRequestFilterInfo())},removeUserFilter:function(e){var t=c.FilterRuleBuilder.createRule(e,h.AntiBannerFiltersId.USER_FILTER_ID);if(null!==t){var i=this._getFilterById(h.AntiBannerFiltersId.USER_FILTER_ID);this.requestFilter.removeRule(t),f.notifyListeners(R.REMOVE_RULE,i,[t])}a.removeAll(this.userRules,e),f.notifyListeners(R.UPDATE_USER_FILTER_RULES,this.getRequestFilterInfo())},init:function(t){var e=this,i=this.ApplicationUpdateService.getRunInfo(),r=function(e){0===this._requestFilterInitTime&&(this._requestFilterInitTime=(new Date).getTime()),t.runCallback&&t.runCallback(e)}.bind(this),n=function(){c.whiteListService.initWhiteListFilters(),e._createRequestFilter(function(){this._addFiltersChangeEventListener(),r(i)}.bind(this))}.bind(this),s=function(){this._subscribeToFiltersChangeEvents(),i.isFirstRun?r(i):(this.yiclearFilters=this.filterClasses.getAllyiclearFilters(this.subscriptionService),n())}.bind(this);this.subscriptionService.init(s)},_subscribeToFiltersChangeEvents:function(){var i=h.platformUtils.debounce(this._reloadAntiBannerFilters.bind(this),this.RELOAD_FILTERS_DEBOUNCE_PERIOD);f.addListener(function(e,t){e!==R.CHANGE_USER_SETTINGS||t!==c.userSettings.settings.USE_OPTIMIZED_FILTERS?(e==R.CHANGE_USER_SETTINGS&&t==c.userSettings.settings.DISABLE_COLLECT_HITS||e==R.CHANGE_PREFS&&"use_global_style_sheet"==t)&&(this.getRequestFilter().cssFilter.dirty=!0):i()}.bind(this))},_reloadAntiBannerFilters:function(){},_resetFiltersVersion:function(){},isApplicationFilteringDisabled:function(){return this.applicationFilteringDisabled},isRequestFilterReady:function(){return 0<this._requestFilterInitTime},shouldCollapseAllElements:function(){return 0<this._requestFilterInitTime&&this._requestFilterInitTime+3e3>(new Date).getTime()},getRequestFilter:function(){return this.requestFilter},getUserAutoFilterRules:function(e,t,i){for(var r=h.StringUtils,n=this.userFilterAutoRules,s=[],l=0;l<n.length;l++){var u=n[l];i&&!r.containsIgnoreCase(u,i)||s.push(u)}return t?s.slice(e,e+t):s},getUserFilters:function(e,t,i){for(var r=h.StringUtils,n=this.userRules,s=[],l=0;l<n.length;l++){var u=n[l];i&&!r.containsIgnoreCase(u,i)||s.push(u)}return t?s.slice(e,e+t):s},clearUserFilterAutoRule:function(){this.userFilterAutoRules=[],this.requestFilter.passFilter.clearRules();var e=this._getFilterById(h.AntiBannerFiltersId.USER_FILTER_AUTO_ID);f.notifyListeners(R.UPDATE_FILTER_RULES,e,[]),f.notifyListeners(R.UPDATE_USER_FILTER_AUTO_RULES,this.getRequestFilterInfo())},clearUserFilter:function(){this.userRules=[];var e=this._getFilterById(h.AntiBannerFiltersId.USER_FILTER_ID);f.notifyListeners(R.UPDATE_FILTER_RULES,e,[]),f.notifyListeners(R.UPDATE_USER_FILTER_RULES,this.getRequestFilterInfo())},whiteListFrame:function(e){c.whiteListService.whiteListUrl(e.url),f.notifyListeners(R.UPDATE_WHITELIST_FILTER_RULES)},unWhiteListFrame:function(e){e.frameRule&&(c.whiteListService.unWhiteListUrl(e.url),f.notifyListeners(R.UPDATE_WHITELIST_FILTER_RULES))},getWhiteListDomains:function(e,t,i){for(var r=h.StringUtils,n=c.whiteListService.getWhiteList(),s=[],l=0;l<n.length;l++){var u=n[l];i&&!r.containsIgnoreCase(u,i)||s.push(u)}return t?s.slice(e,e+t):s},addWhiteListDomain:function(e){c.whiteListService.addToWhiteList(e),f.notifyListeners(R.UPDATE_WHITELIST_FILTER_RULES)},addWhiteListDomains:function(e){c.whiteListService.addToWhiteListArray(e),f.notifyListeners(R.UPDATE_WHITELIST_FILTER_RULES)},removeWhiteListDomain:function(e){c.whiteListService.removeFromWhiteList(e),f.notifyListeners(R.UPDATE_WHITELIST_FILTER_RULES)},clearWhiteListFilter:function(){c.whiteListService.clearWhiteList(),f.notifyListeners(R.UPDATE_WHITELIST_FILTER_RULES)},_addFiltersChangeEventListener:function(){var a=[],F=null,r=function(e,t,i){a.push({event:e,filter:t,rules:i}),null!==F&&clearTimeout(F),F=setTimeout(function(){var e=a.slice(0);a=[],F=null;for(var t=e.some(function(e){return 0<=d.indexOf(e.event)}),i=Object.create(null),r=0;r<e.length;r++){var n=e[r];n.filter.filterId in i||(i[n.filter.filterId]=[]),i[n.filter.filterId].push(n)}function s(e){return 0<=E.indexOf(e.event)}var l=[];for(var u in i){if(i[u].some(s)){var o=this._processSaveFilterRulesToFSEvents(u,i[u]);l.push(o)}}t?h.vPromise.all(l).then(this._createRequestFilter.bind(this)):f.notifyListeners(R.REQUEST_FILTER_UPDATED,this.getRequestFilterInfo())}.bind(this),this.FILTERS_CHANGE_DEBOUCE_PERIOD)}.bind(this);f.addListener(function(e,t,i){switch(e){case R.ADD_RULE:case R.ADD_RULES:case R.REMOVE_RULE:case R.UPDATE_FILTER_RULES:case R.ENABLE_FILTER:case R.DISABLE_FILTER:r(e,t,i)}})},_processSaveFilterRulesToFSEvents:function(l,u){var o=new h.vPromise;return c.FilterStorage.loadFilterRules(l,function(e){for(var t=0;t<u.length;t++){e=e||[];var i=u[t],r=i.event,n=i.rules;switch(r){case R.ADD_RULE:case R.ADD_RULES:e=e.concat(a.getRulesText(n));break;case R.REMOVE_RULE:var s=n[0];a.removeAll(e,s.ruleText);break;case R.UPDATE_FILTER_RULES:e=a.getRulesText(n)}}c.FilterStorage.saveFilterRules(l,e,o.resolve)}.bind(this)),o}};var d=[R.UPDATE_FILTER_RULES,R.ENABLE_FILTER,R.DISABLE_FILTER],E=[R.UPDATE_FILTER_RULES,R.ADD_RULE,R.ADD_RULES,R.REMOVE_RULE]}(yiclearAPI,vAPI),function(){var e=vAPI.EventNotifier;yiclearAPI.UI,vAPI.platformUtils;e.addListener(function(e,t,i){e==vAPI.EventNotifierTypes.UPDATE_FILTERS_SHOW_POPUP&&(yiclearAPI.UI.showAlertMessagePopup(i.title,i.version),console.log("123"))})}();