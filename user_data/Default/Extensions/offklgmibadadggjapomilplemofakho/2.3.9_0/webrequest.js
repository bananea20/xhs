!function(){"use strict";var d="Content-Security-Policy",v="connect-src http: https:; frame-src http: https:; child-src http: https:",l=vAPI.EventNotifierTypes,u=vAPI.EventNotifier,r=vAPI.ext.webRequest,i=[],n=1,a=Object.create(null);function c(e,r,t,s){if(r){delete a[e];var i=yiclear.webRequestService.getRuleForRequest(s,r,t,vAPI.RequestTypes.POPUP);yiclear.webRequestService.isRequestBlockedByRule(i)&&(vAPI.ext.tabs.remove(e),yiclear.webRequestService.postProcessRequest(s,r,t,vAPI.RequestTypes.DOCUMENT,i))}}if(vAPI.ext.webNavigation.onCreatedNavigationTarget.addListener(function(e){var r={id:e.sourceTabId};if(!yiclear.framesMap.isTabyiclearDetected(r)){var t=yiclear.framesMap.getMainFrameUrl(r)||e.url;if(vAPI.UrlUtils.isHttpRequest(t)){var s=e.tabId;a[s]={referrerUrl:t,sourceTab:r},c(s,e.url,t,r)}}},{urls:["<all_urls>"]}),vAPI.ext.tabs.onUpdated.addListener(function(e){var r=e.id;if(r in a&&e.url){var t=a[r];t&&c(r,e.url,t.referrerUrl,t.sourceTab)}}),r.onCompleted.addListener(function(e){var r=function(e){for(var r={loadtime:null,RequestTypes:null,tab:null},t=0;t<i.length;t++){var s=i[t];s.requestUrl===e.url&&(r.loadtime=e.timeStamp-s.requestTime,r.tab=s.tab,r.RequestTypes=s.requestType,i.splice(t-i.length,1))}return r.loadtime=Math.round(r.loadtime),r}(e),t=e.url;yiclear.webRequestService.filteringLogEventUpdate(r.tab,t,r.RequestTypes,r.loadtime)},{urls:["<all_urls>"]},["responseHeaders"]),r.onBeforeRequest.addListener(function(e){var r=e.tab,t=e.requestUrl,s=e.requestType;if(!vAPI.UrlUtils.isHttpRequest(t))return!0;s!==vAPI.RequestTypes.DOCUMENT&&s!==vAPI.RequestTypes.SUBDOCUMENT||yiclear.framesMap.recordFrame(r,e.frameId,t,s),s===vAPI.RequestTypes.DOCUMENT&&u.notifyListeners(l.UPDATE_TAB_BUTTON_STATE,r,!0);var i=yiclear.framesMap.getFrameUrl(r,e.requestFrameId),a=yiclear.webRequestService.getRuleForRequest(r,t,i,s);return null!==a&&void 0!==a.RedirectUrls?{redirectUrl:t.replace(a.urlRegExp,a.RedirectUrls)}:s===vAPI.RequestTypes.DOCUMENT||(null!==a&&void 0!==a.BCount?!(1<++n&&n%Number(a.BCount)==0):(yiclear.webRequestService.postProcessRequest(r,t,i,s,a),yiclear.webRequestService.getBlockedResponseByRule(a)))},["<all_urls>"]),r.onBeforeSendHeaders.addListener(function(e){i.push(e);var r=e.tab,t=e.requestHeaders;if("DOCUMENT"===e.requestType){var s=vAPI.platformUtils.findHeaderByName(t,"Referer");s&&yiclear.framesMap.recordFrameReferrerHeader(r,s.value)}},["<all_urls>"]),r.onHeadersReceived.addListener(function(e){var r=e.tab,t=e.requestUrl,s=e.responseHeaders,i=e.requestType,a=yiclear.framesMap.getFrameUrl(r,e.requestFrameId);if(yiclear.webRequestService.processRequestResponse(r,t,a,i,s),i===vAPI.RequestTypes.DOCUMENT||i===vAPI.RequestTypes.SUBDOCUMENT)return function(e){if(vAPI.platformUtils.isEdgeBeforeCreatorsUpdate())return;var r=e.tab,t=e.requestUrl,s=e.responseHeaders||[],i=e.requestType,a=yiclear.framesMap.getFrameUrl(r,e.frameId),l=[],u=function(e,r){var t=null,s=!1;vAPI.ext.webRequest.webSocketSupported||(t=yiclear.webRequestService.getRuleForRequest(e,"ws://yiclearwebsocket.check",r,vAPI.RequestTypes.WEBSOCKET),s=yiclear.webRequestService.isRequestBlockedByRule(t));s||(t=yiclear.webRequestService.getRuleForRequest(e,"stun:yiclearwebrtc.check",r,vAPI.RequestTypes.WEBRTC));return t}(r,a);yiclear.webRequestService.isRequestBlockedByRule(u)&&l.push({name:d,value:v});u&&yiclear.filteringLog.addEvent(r,"content-security-policy-check",a,vAPI.RequestTypes.CSP,u);var n=yiclear.webRequestService.getCspRules(r,t,a,i);if(n)for(var c=0;c<n.length;c++){var o=n[c];yiclear.webRequestService.isRequestBlockedByRule(o)&&l.push({name:d,value:o.cspDirective}),yiclear.filteringLog.addEvent(r,t,a,vAPI.RequestTypes.CSP,o)}if(0<l.length)return{responseHeaders:s=s.concat(l),modifiedHeaders:l}}(e)},["<all_urls>"]),!vAPI.platformUtils.isEdgeBrowser()){var e=vAPI.ext.getURL("elemhidehit.png");r.onBeforeRequest.addListener(function(e){if(!yiclear.framesMap.isIncognitoTab(e.tab)){var r=yiclear.framesMap.getFrameDomain(e.tab),t=function(e){if(!e)return null;var r=decodeURIComponent(vAPI.StringUtils.substringAfter(e,"#"));return{filterId:vAPI.StringUtils.substringBefore(r,";"),ruleText:vAPI.StringUtils.substringAfter(r,";")}}(e.requestUrl);t&&yiclearAPI.filterRulesHitCount.addRuleHit(r,t.ruleText,t.filterId)}},[e])}var o,t=null;u.addListener(function(e){switch(e){case l.ADD_RULE:case l.ADD_RULES:case l.REMOVE_RULE:case l.UPDATE_FILTER_RULES:case l.ENABLE_FILTER:case l.DISABLE_FILTER:null!=t&&clearTimeout(t),t=setTimeout(function(){t=null,r.handlerBehaviorChanged()},3e3)}}),o=vAPI.platformUtils.isEdgeBrowser(),vAPI.ext.webNavigation.onCommitted.addListener(function(e,r,t){if(0===r||!o){var s=yiclear.webRequestService.processGetSelectorsAndScripts({tabId:e},t,{filter:["scripts"]});s.scripts&&0!==s.scripts.length&&(s.type="injectScripts",function r(t,s,i,a,l){vAPI.ext.tabs.sendMessage(t,a,function(e){if(!e){if(--l<=0)return;setTimeout(function(){r(t,s,i,a,l)},10)}})}(e,r,t,s,5))}})}();