!function(){"use strict";var r=null,s=null,t=null,i={requestWizard:RequestWizard,init:function(){this.requestWizard.Init(r,t),this.logTable=$("#logTable"),this.logTableEmpty=$("#logTableEmpty"),this.logTableHidden=!0,this.tabSelector=$("#tabSelector"),this.tabSelectorValue=this.tabSelector.find(".task-manager-header-dropdown-select-text"),this.tabSelectorList=this.tabSelector.find(".task-manager-header-dropdown-select-list"),this.logoIcon=$("#logoIcon"),this.tabSelectorValue.dropdown(),this.tabSelector.on("show.bs.dropdown",function(){this.tabSelector.addClass("opened")}.bind(this)),this.tabSelector.on("hide.bs.dropdown",function(){this.tabSelector.removeClass("opened")}.bind(this)),this.tabSelectorList.on("click","div",function(e){var t=$(e.currentTarget);document.location.hash="#"+t.attr("data-tab-id")}.bind(this)),$(window).on("hashchange",function(){this._updateTabIdFromHash(),this.onSelectedTabChange()}.bind(this)),this.searchRequest=null,this.searchTypes=[],this.searchThirdParty=!1,this.searchBlocked=!1,this.searchWhitelisted=!1,$(".task-manager").on("click",".reloadTab",function(e){e.preventDefault(),contentPage.sendMessage({type:"reloadTabById",tabId:this.currentTabId})}.bind(this)),$("#clearTabLog").on("click",function(e){e.preventDefault(),contentPage.sendMessage({type:"clearEventsByTabId",tabId:this.currentTabId})}.bind(this));var n=this;this.logTable.on("click",".task-manager-content-header-body-row",function(){var a=$(this).data();contentPage.sendMessage({type:"getTabFrameInfoById",tabId:n.currentTabId},function(e){var t=e.frameInfo;t&&n.requestWizard.showRequestInfoModal(t,a)})}),this._bindSearchFilters(),this._updateTabIdFromHash(),contentPage.sendMessage({type:"synchronizeOpenTabs"},function(e){for(var t=e.tabs,a=0;a<t.length;a++)this.onTabUpdated(t[a]);this.onSelectedTabChange()}.bind(this))},_updateTabIdFromHash:function(){if(document.location.hash){var e=document.location.hash.substring(1);e&&(this.currentTabId=parseInt(e))}},onTabAdded:function(e){e.isHttp&&(this.tabSelectorList.append($("<div>",{class:"task-manager-header-dropdown-select-list-item",text:e.tab.title,"data-tab-id":e.tabId})),this.currentTabId||this.onSelectedTabChange())},onTabUpdated:function(e){var t=this.tabSelectorList.find("[data-tab-id="+e.tabId+"]");e.isHttp?t&&0<t.length?(t.text(e.tab.title),e.tabId===this.currentTabId&&(this.tabSelectorValue.text(e.tab.title),this._updateLogoIcon())):this.onTabAdded(e):this.onTabClose(e)},onTabClose:function(e){this.tabSelectorList.find("[data-tab-id="+e.tabId+"]").remove(),this.currentTabId===e.tabId&&(this.currentTabId=null,this.onSelectedTabChange())},onTabReset:function(e){this.currentTabId===e.tabId&&(this.logTable.empty(),this._onEmptyTable())},onEventAdded:function(e,t){this.currentTabId===e.tabId&&this._renderEvents([t])},onEventUpdate:function(e,t){this.currentTabId===e.tabId&&this._UpdateTime([t])},_UpdateTime:function(e){if(e&&0!==e.length)for(var t=this.logTable.find(".task-manager-content-header-body-row"),a=!1,n=0;n<t.length;n++){for(var s=$(t[n]).find(".task-manager-content-item-url").text(),i=0;i<e.length;i++)if(s===e[i].requestUrl){$(t[n]).find(".task-manager-content-item-time").text(e[i].loadTime+"ms"),a=!0;break}if(a)break}else this._onEmptyTable()},onSelectedTabChange:function(){var e=this.tabSelectorList.find('[data-tab-id="'+this.currentTabId+'"]');0===e.length&&(e=this.tabSelectorList.find(":first"));var t="",a=null;0<e.length&&(t=e.text(),a=e.attr("data-tab-id")),this.currentTabId=parseInt(a),this.tabSelectorValue.text(t),this._updateLogoIcon(),this._renderEventsForTab(this.currentTabId)},_updateLogoIcon:function(){contentPage.sendMessage({type:"getTabFrameInfoById",tabId:this.currentTabId},function(e){var t="../icons/new-26.png";e.frameInfo&&(t="../icons/new-26.png"),this.logoIcon.attr("src",t)}.bind(this))},_bindSearchFilters:function(){var n=this;$('[name="searchEventRequest"]').on("keyup",function(){n.searchRequest=this.value.trim(),n._filterEvents()});var s=$(".searchEventType");s.on("click",function(e){e.preventDefault(),s.parent().removeClass("active");var t=$(e.currentTarget);t.parent().addClass("active");var a=t.attr("attr-type");n.searchTypes=a?a.split(","):[],n._filterEvents()}),$('[name="searchEventThirdParty"]').on("change",function(){n.searchThirdParty=this.checked,n._filterEvents()}),$('[name="searchEventBlocked"]').on("change",function(){n.searchBlocked=this.checked,n._filterEvents()}),$('[name="searchEventWhitelisted"]').on("change",function(){n.searchWhitelisted=this.checked,n._filterEvents()})},_filterEvents:function(){var e=this.logTable.children();if(this.searchRequest||0!==this.searchTypes.length||this.searchThirdParty||this.searchBlocked||this.searchWhitelisted){var t=this;$.each(e,function(){t._handleEventShow($(this))})}else e.removeClass("hidden")},_onEmptyTable:function(){this.logTableHidden=!0,this.logTable.addClass("hidden"),this.logTableEmpty.removeClass("hidden")},_onNotEmptyTable:function(){this.logTableHidden&&(this.logTableHidden=!1,this.logTableEmpty.addClass("hidden"),this.logTable.removeClass("hidden"))},_renderEventsForTab:function(e){this.logTable.empty(),contentPage.sendMessage({type:"getTabInfoById",tabId:e},function(e){var t=e.tabInfo,a=[];t&&(a=t.filteringEvents||[]),this._renderEvents(a)}.bind(this))},_renderEvents:function(e){if(e&&0!==e.length){for(var t=[],a=0;a<e.length;a++){var n=this._renderTemplate(e[a]);this._handleEventShow(n),t.push(n)}this._onNotEmptyTable(),this.logTable.append(t)}else this._onEmptyTable()},_renderTemplate:function(e){var t={data:e,class:"task-manager-content-header-body-row cf"};e.requestRule&&(t.class+=e.requestRule.whiteListRule?" green":" red");var a="";e.requestRule&&(a=e.requestRule.filterId===r.WHITE_LIST_FILTER_ID?Messages.IN_WHITELIST:e.requestRule.ruleText);var n="task-manager-content-header-body-col task-manager-content-item-type";e.requestThirdParty&&(n+=" third-party");var s=$("<div>",t);s.append($("<div>",{text:e.requestUrl,class:"task-manager-content-header-body-col task-manager-content-item-url"})),s.append($("<div>",{text:RequestWizard.getRequestType(e.requestType),class:n})),s.append($("<div>",{text:a,class:"task-manager-content-header-body-col task-manager-content-item-rule"})),s.append($("<div>",{text:RequestWizard.getSource(e.frameDomain),class:"task-manager-content-header-body-col task-manager-content-item-source"}));var i=e.loadTime||"0";return s.append($("<div>",{text:i+"ms",class:"task-manager-content-header-body-col task-manager-content-item-time"})),s},_handleEventShow:function(e){var t=e.data(),a=!this.searchRequest||RequestWizard.StringUtils.containsIgnoreCase(t.requestUrl,this.searchRequest);a&=0===this.searchTypes.length||0<=this.searchTypes.indexOf(t.requestType);var n=!(this.searchWhitelisted||this.searchBlocked||this.searchThirdParty);n|=this.searchWhitelisted&&t.requestRule&&t.requestRule.whiteListRule,n|=this.searchBlocked&&t.requestRule&&!t.requestRule.whiteListRule,(a&=n|=this.searchThirdParty&&t.requestThirdParty)?e.removeClass("hidden"):e.addClass("hidden")}};contentPage.sendMessage({type:"initializeFrameScript"},function(e){e.userSettings,e.enabledFilters,t=e.filtersMetadata,e.environmentOptions,r=e.constants.AntiBannerFiltersId,e.constants.EventNotifierTypes,s=e.constants.LogEvents,$(document).ready(function(){var n=i;var t,e=[s.TAB_ADDED,s.TAB_UPDATE,s.TAB_CLOSE,s.TAB_RESET,s.EVENT_ADDED,s.EVENT_UPDATE];contentPage.sendMessage({type:"onOpenFilteringLogPage"}),contentPage.sendMessage({type:"addEventListener",events:e},function(e){t=e.listenerId}),contentPage.onMessage.addListener(function(e){"notifyListeners"===e.type&&function(e,t,a){switch(e){case s.TAB_ADDED:n.onTabAdded(t);break;case s.TAB_UPDATE:n.onTabUpdated(t);break;case s.TAB_CLOSE:n.onTabClose(t);break;case s.TAB_RESET:n.onTabReset(t);break;case s.EVENT_ADDED:n.onEventAdded(t,a);break;case s.EVENT_UPDATE:n.onEventUpdate(t,a)}}.apply(this,e.args)});function a(){t&&(contentPage.sendMessage({type:"removeListener",listenerId:t}),contentPage.sendMessage({type:"onCloseFilteringLogPage"}),t=null)}$(window).on("beforeunload",a),$(window).on("unload",a),n.init()})})}();