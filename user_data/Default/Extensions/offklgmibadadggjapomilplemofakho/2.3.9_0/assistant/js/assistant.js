var YiclearAssistant=function(u){function c(){return v.croppedDomain||(v.croppedDomain=b.cropDomain(h().host)),v.croppedDomain}function o(e){return f.localization[e]}function r(e){function i(e){return{x:(e=e||window.event).screenX,y:e.screenY}}function c(e){e.preventDefault(),e.stopPropagation()}function o(e){var t=i(e);!function(e,t){var n=e,l=t;n<0&&(n=0),l<0&&(l=0),s.css("left",n+"px"),s.css("top",l+"px")}(t.x+d.x,t.y+d.y)}var s=k(),a=x("#drag-handle"),r=u(e.contentDocument),d=Object.create(null);a.on("mousedown",function(e){var t=i(e),n=a.get(0),l=s.get(0).getBoundingClientRect();d.x=l.left+n.offsetLeft-t.x,d.y=l.top+n.offsetTop-t.y,r.on("mousemove",o),r.on("selectstart",c)}),r.on("mouseup",function(){r.off("mousemove",o),r.off("selectstart",c)})}function d(e,t,n){var l={width:window.innerWidth,height:window.innerHeight},i=function(e,t,n,l){return{left:t.width-l-e,top:e}}(m.topOffset,l,0,e),c=document.createElement("iframe");return c.setAttribute("id",v.iframeId),c.setAttribute("class","sg_ignore yi-view-important"),c.setAttribute("frameBorder","0"),c.setAttribute("allowTransparency","true"),c.style.width=e+"px",c.style.height=t+"px",c.style.position="fixed",c.style.left=i.left+"px",c.style.top=i.top+"px",c.style.zIndex=9999,u(c).on("load",p.bind(null,c,n)),document.body.appendChild(c),c}function n(e,t,n,l,i){function c(){y(a,e),function(e,t,n){t&&t(e),r(e),x("body").removeClass("yi-hide"),n&&n(e)}(a,l,i),T()}var o=k();if(0<o.length)return a=o.get(0),g(t,n,a),void c();var s=new Deferred;s.done(c);var a=d(t,n,s)}function l(e,t){for(var n in t)u(e.contentDocument.querySelectorAll(n)).on("click",t[n])}function i(e){e.preventDefault();var t=new Deferred;t.done(function(){S(),O(),E()}),A(t)}function s(e){e.preventDefault(),O(),_(),w()}function e(e){v.selectedElement=e;var t=C(e),n=D(e);B(e,t,n)}function a(t){var e=u('<div class="main"><div class="close yi-close"></div><div class="head" id="drag-handle">\t<div i18n="assistant_block_element" class="head_title" id="head_title"></div>\t<div i18n="assistant_block_element_explain" class="head_text" id="head_text"></div></div><div class="content">\t<div class="element-rule">\t\t<div i18n="assistant_slider_explain" class="element-rule_text"></div>\t\t<div class="element-rule_slider">\t\t\t<div class="yi-slide" id="slider">\t\t\t\t<div class="yi-slide-clue-max">MAX</div>\t\t\t\t<div class="yi-slide-clue-min">MIN</div>\t\t\t</div>\t\t</div>\t\t<div class="element-rule_more">\t\t\t<span class="element-rule_expand-link" id="ExtendedSettingsText">\t\t\t\t<span i18n="assistant_extended_settings" class="element-rule_expand-link_txt"></span>\t\t\t\t<span class="element-rule_expand-link_arr"></span>\t\t\t</span>\t\t</div>\t\t<div class="element-rule_form" id="adv-settings">\t\t\t<div class="element-rule_form-cont">\t\t\t\t<div class="element-rule_fieldset" id="one-domain-checkbox-block">\t\t\t\t\t<input class="form-ui-control" id="one-domain-checkbox" type="checkbox"/>\t\t\t\t\t<label for="one-domain-checkbox" class="form-ui">\t\t\t\t\t\t<span i18n="assistant_apply_rule_to_all_sites" class="form-ui-txt"></span>\t\t\t\t\t</label>\t\t\t\t</div>\t\t\t\t<div style="display: none;" class="element-rule_fieldset" id="block-by-url-checkbox-block">\t\t\t\t\t<input class="form-ui-control" id="block-by-url-checkbox" type="checkbox"/>\t\t\t\t\t<label for="block-by-url-checkbox" class="form-ui">\t\t\t\t\t\t<span i18n="assistant_block_by_reference" class="form-ui-txt"></span>\t\t\t\t\t</label>\t\t\t\t</div>\t\t\t\t<div style="display: none;" class="element-rule_fieldset" id="block-similar-checkbox-block">\t\t\t\t\t<input class="form-ui-control" id="block-similar-checkbox" type="checkbox"/>\t\t\t\t\t<label for="block-similar-checkbox" class="form-ui">\t\t\t\t\t\t<span i18n="assistant_block_similar" class="form-ui-txt"></span>\t\t\t\t\t</label>\t\t\t\t</div>\t\t\t\t<div style="display: none;" class="element-rule_fieldset" id="block-class-checkbox-block">\t\t\t\t\t<input class="form-ui-control" id="block-class-checkbox" type="checkbox"/>\t\t\t\t\t<label for="block-class-checkbox" class="form-ui">\t\t\t\t\t\t<span i18n="assistant_block_class" class="form-ui-txt"></span>\t\t\t\t\t</label>\t\t\t\t</div>\t\t\t\t<div class="element-rule_fieldset">\t\t\t\t\t<input class="form-control" id="filter-rule" type="text"/>\t\t\t\t</div>\t\t\t</div>\t\t</div>\t</div></div><div class="foot">\t<button i18n="assistant_another_element" type="button" class="btn btn-default" id="yi-cancel"></button>\t<div class="foot_action">\t\t<div class="foot_action_btn">\t\t\t<button i18n="assistant_preview" type="button" class="btn btn-primary" id="yi-preview"></button>\t\t\t<button i18n="assistant_block" type="button" class="btn btn-cancel" id="yi-accept"></button>\t\t</div>\t</div></div></div>');n(e,m.baseWidth,m.detailedMenuHeight,function(e){l(e,{"#close-button":s,".yi-close":s,"#adv-settings":U,"#yi-cancel":i,"#yi-preview":R,"#yi-accept":W,"#ExtendedSettingsText":L}),t.resolve()},function(){S()})}function t(e,t){var n=k().get(0);t&&(n.style.height=t+"px"),e&&(n.style.width=e+"px"),T()}var f=this,v={iframeId:"yiclear-assistant-dialog",path:null,selectedElement:null,lastPreview:null,cssRuleIndex:null,urlBlockAttributes:["src","data"],urlInfo:null,croppedDomain:null},m={baseWidth:668,extendDetailedSettingsHeight:503,detailedMenuHeight:340,selectorMenuHeight:213,topOffset:25},b={getAllChilds:function(e){for(var t=[],n=e;n=b.getChildren(n);)t.push(n);return t},getChildren:function(e){var t=e.childNodes;if(t){var n,l,i=0;for(l=0;l<t.length;l++)1==t[l].nodeType&&(n=t[l],i++)}return 1==i?n:null},getParentsLevel:function(e){for(var t=e,n=[];(t=t.parentNode)&&"BODY"!=b.getNodeName(t);)n.push(t);return n},getNodeName:function(e){return e&&e.nodeName?e.nodeName.toUpperCase():""},getUrl:function(e){var t=new RegExp("^(([^:/\\?#]+):)?(//(([^:/\\?#]*)(?::([^/\\?#]*))?))?([^\\?#]*)(\\?([^#]*))?(#(.*))?$").exec(e);return{host:t[4]||"",path:t[7]||""}},cropDomain:function(e){return e.replace("www.","").replace(/:\d+/,"")}},h=function(){return v.urlInfo||(v.urlInfo=b.getUrl(document.location)),v.urlInfo},p=function(e,o){try{var t=e.contentDocument;t.open(),t.write("<html><head></head></html>"),t.close()}catch(e){}contentPage.sendMessage({type:"loadAssistant"},function(e){e.localization&&(f.localization=e.localization);var t=e.cssContent,n=e.cssLink,l=document.getElementById(v.iframeId).contentDocument.getElementsByTagName("head")[0];if(t){var i=document.createElement("style");i.type="text/css",i.textContent=t,l.appendChild(i)}if(n){var c=document.createElement("link");c.type="text/css",c.rel="stylesheet",c.href=n,l.appendChild(c)}o.resolve()})},k=function(){return u("#"+v.iframeId)},x=function(e){return u(k().get(0).contentDocument.querySelectorAll(e))},g=function(e,t,n){n.style.width=e+"px",n.style.height=t+"px"},y=function(e,t){for(var n=e.contentDocument.body,l=0;l<n.children.length;l++)n.removeChild(n.children[l]);n.appendChild(t.get(0)),x("body").addClass("yi-hide")},_=function(){YiclearSelectorLib.close()},w=function(){_(),k().remove()},E=function(){YiclearSelectorLib.reset(),YiclearSelectorLib.init(e)},C=function(e){var t=H(e);return t&&""!=t},D=function(e){var t=e.className;return t&&""!=t.trim()},S=function(){for(var e=x("[i18n]"),t=0;t<e.length;t++){var n=o(e[t].getAttribute("i18n"));I18nHelper.translateElement(e[t],n)}x("#blockClass").hide(),x("#blockSimilar").hide(),x("#blockByUrl").hide(),x("#oneDomainRadio").hide()},A=function(t){var e=u('<div class="main sg_ignore"><div class="close yi-close" id="close-button"></div><div class="head" id="drag-handle">\t<div i18n="assistant_select_element" class="head_title"></div>\t<div i18n="assistant_select_element_ext" class="head_text"></div></div><div class="foot">\t<button i18n="assistant_select_element_cancel" type="button" class="btn btn-default" id="cancel-select-mode"></button></div></div>');n(e,m.baseWidth,m.selectorMenuHeight,function(e){l(e,{"#cancel-select-mode":s,".yi-close":s}),t.resolve()},null)},B=function(e,t,n){var l=new Deferred;l.done(function(){N(e),YiclearSelectorLib.selectElement(e),U(),M(),I(t,n)}),a(l)},T=function(){var e=window.innerHeight,t=document.body.scrollTop+e,n=k().get(0),l=n.getBoundingClientRect().top+document.body.scrollTop,i=n.offsetHeight;if(t<l+i){var c=e-i-m.topOffset;c<0&&(c=m.topOffset),n.style.top=c+"px"}},L=function(){!x("#adv-settings").hasClass("open")?(t(null,m.extendDetailedSettingsHeight),x("#adv-settings").addClass("open"),x("#ExtendedSettingsText").addClass("active")):(t(null,m.detailedMenuHeight),x("#adv-settings").removeClass("open"),x("#ExtendedSettingsText").removeClass("active"))},M=function(){var e=c();x("#oneDomainText").text(e)},N=function(n){var l=b.getParentsLevel(n),i=b.getAllChilds(n),e=Math.abs(l.length+1),t=l.length+i.length+1,c={value:e,min:1,max:t};1==t&&(x("#slider").hide(),x(".element-rule_text").text(o("assistant_slider_if_hide"))),c.onSliderMove=function(e){var t;0<e&&(t=l[e-1]),0==e&&(t=n),e<0&&(t=i[Math.abs(e+1)]),P(t)},SliderWidget.init(x("#slider").get(0),{min:c.min,max:c.max,value:c.value,onValueChanged:function(e){var t=c.value-e;c.onSliderMove(t)}})},I=function(e,t){e?x("#block-by-url-checkbox-block").show():(x("#block-by-url-checkbox").get(0).checked=!1,x("#block-by-url-checkbox-block").hide()),t?(x("#block-similar-checkbox-block").show(),x("#block-class-checkbox-block").show()):(x("#block-similar-checkbox").get(0).checked=!1,x("#block-similar-checkbox-block").hide(),x("#block-class-checkbox").get(0).checked=!1,x("#block-class-checkbox-block").hide())},P=function(e){O(),v.selectedElement=e,YiclearSelectorLib.selectElement(e),Y(),U(),I(C(e),D(e))},Y=function(){x("#block-by-url-checkbox").get(0).checked=!1,x("#block-similar-checkbox").get(0).checked=!1,x("#block-class-checkbox").get(0).checked=!1,x("#one-domain-checkbox").get(0).checked=!1},H=function(e){for(var t=0;t<v.urlBlockAttributes.length;t++){var n=v.urlBlockAttributes[t],l=e.getAttribute(n);if(l)return l}return null},R=function(e){if(e&&e.preventDefault(),v.lastPreview)return O(),x("#head_title").text(o("assistant_block_element")),x("#head_text").text(o("assistant_block_element_explain")),x("#yi-preview").text(o("assistant_preview_start")),YiclearSelectorLib.selectElement(v.selectedElement),void x(".content").show();z(),x("#head_title").text(o("assistant_preview_header")),x("#head_text").text(o("assistant_preview_header_info")),x("#yi-preview").text(o("assistant_preview_end")),x(".content").hide()},z=function(){YiclearSelectorLib.reset();var e=x("#block-similar-checkbox").get(0).checked,t=YiclearRulesConstructorLib.constructCssSelector(v.selectedElement,e),n=document.createElement("style");n.setAttribute("type","text/css"),v.lastPreview=n;var l=document.getElementsByTagName("head")[0];l&&(n.appendChild(document.createTextNode(t+" {display: none !important;}")),l.appendChild(n))},O=function(){if(null!=v.lastPreview){var e=document.getElementsByTagName("head")[0];e&&e.removeChild(v.lastPreview),v.lastPreview=null}},U=function(){var e=x("#block-by-url-checkbox").get(0).checked,t=x("#block-similar-checkbox").get(0).checked,n=x("#block-class-checkbox").get(0).checked,l=x("#one-domain-checkbox").get(0).checked;I(C(v.selectedElement)&&!t,D(v.selectedElement)&&!e);var i={isBlockByUrl:e,urlMask:H(v.selectedElement),isBlockSimilar:t,isBlockClass:n,isBlockOneDomain:l,domain:c()};!function(e){x("#filter-rule").get(0).value=e}(YiclearRulesConstructorLib.constructRuleText(v.selectedElement,i))},W=function(){O(),R(),v.lastPreview=null;var e=x("#filter-rule").get(0).value;contentPage.sendMessage({type:"addUserRule",ruleText:e},function(){w()})};function q(){v.selectedElement&&!v.lastPreview&&YiclearSelectorLib.selectElement(v.selectedElement)}u(window).on("resize",q),u(window).on("scroll",q),this.init=function(e){f.localization=e.localization;var t=new Deferred;t.done(function(){S(),O(),E(),e.selectedElement&&e.selectedElement.click()}),A(t)},this.destroy=function(){O(),_(),w()}};