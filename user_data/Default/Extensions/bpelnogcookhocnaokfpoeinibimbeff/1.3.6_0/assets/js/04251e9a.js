"use strict";(globalThis.webpackChunkinfinity_hitab_client=globalThis.webpackChunkinfinity_hitab_client||[]).push([[6160],{74891:(t,s,e)=>{e.d(s,{B:()=>p,DX:()=>u,Fh:()=>m,Fw:()=>S,Hb:()=>f,KC:()=>I,Vq:()=>L,bI:()=>A,fZ:()=>M,l4:()=>d,lk:()=>l,mr:()=>w,pp:()=>v,sT:()=>C,t1:()=>y,ud:()=>T,wY:()=>P,x:()=>g});var i=e(74003),a=e(17904),n=e(57562),r=e(63477),o=e(89660);let c=i.kP;function d(t){const s=(0,i.XF)("chatAiHost");s&&(c=s),(0,n.b$)("chatai",t)}function h(t,s){(0,n.b$)("chatai",!0);let e="";s instanceof Error?e=s.message:"string"==typeof s&&(e=s),o.k.addEvent("network_error",{host:t,error:e})}const l=async()=>{try{d();const t=await a.hj.get(`${c}chat/list`);if(0===t.code&&t.data)return[null,t.data];throw t}catch(t){return["catch error"]}},u=async(t,s,e,i)=>{const n=c;try{d();const r=await a.hj.post(`${n}chat/conversation-v2`,{prompt:t,conversationId:s,assistantId:e,model:i},{_auth:!0,_stream:!0,fetchOpts:{timeout:3e4}});return r||h(n),[null,r]}catch(t){return h(n,t),["catch error"]}},p=async(t,s,e)=>{const i=c;try{d();const n=await a.hj.post(`${i}chat/regenerate-v2`,{conversationId:t,assistantId:s,model:e},{_auth:!0,_stream:!0,fetchOpts:{timeout:3e4}});return n||h(i),[null,n]}catch(t){return h(i,t),["catch error"]}},v=async(t,s)=>{d();const e=c;try{const i=await a.hj.get(`${e}chat/history`,{pageNo:t,pageSize:s},{_auth:!0,timeout:5e3});if(0===i.code&&i.data)return[null,i.data];throw h(e,i.message),i}catch(t){return h(e,t),["catch error"]}},g=async t=>{try{d();const s=await a.hj.post(`${c}chat/delete`,{conversationId:t},{_auth:!0});if(0===s.code&&s.data)return[null,s.data];throw s}catch(t){return["catch error"]}},m=async()=>{try{d();const t=await a.hj.get(`${c}chat/recommended`);if(0===t.code&&t.data)return[null,t.data];throw t}catch(t){return["catch error"]}},L=async()=>{try{d();const t=await a.hj.get(`${c}chat/assistant-list`,{},{_auth:!0});if(0===t.code&&t.data)return[null,t.data];throw t}catch(t){return["catch error"]}},y=async()=>{try{const s=await a.hj.get(`${i.H}chat-pay/plan2`,{},{_auth:!0});var t;if(0===s.code&&s.data)return[null,null===(t=s.data)||void 0===t?void 0:t.list];throw s}catch(t){return["catch error"]}},f=async()=>{try{const t=await a.hj.get(`${i.H}chat-pay/pay-platform`,void 0,{_auth:!0});if(0===t.code&&t.data)return[null,t.data];throw t}catch(t){return["catch error"]}},w=async(t,s)=>{try{const e=await a.hj.post(`${i.H}chat-pay/create-order`,{planId:t,payPlatform:s},{_auth:!0});if(0===e.code&&e.data)return[null,e.data];if(5006===e.code)return[e.message||"创建订单失败!",null];throw e}catch(t){return["catch error"]}},I=async()=>{try{const t=await a.hj.post(`${i.H}chat-pay/check-order`,void 0,{_auth:!0});if(0===t.code&&t.data)return[null,t.data];throw t}catch(t){return["catch error"]}},T=async t=>{try{const s=await a.hj.post(`${i.H}chat-pay/check-order-ids`,{ids:t},{_auth:!0});if(0===s.code&&s.data)return[null,s.data];throw s}catch(t){return["catch error"]}},S=async t=>{try{const s=await a.hj.get(`${i.H}chat-pay/order-list`,{check:t},{_auth:!0});if(0===s.code&&s.data){return[null,{list:s.data.list.map((t=>(t.paySuccessTimStr=(0,r.F8)(t.paySuccessTime),t.payAmount=`¥${t.payAmount}`,t)))}]}throw s}catch(t){return["catch error"]}},C=async()=>{try{const t=await a.hj.get(`${i.H}chat-pay/vip-group`,void 0,{_auth:!0});if(0===t.code&&t.data)return[null,t.data];throw t}catch(t){return["catch error"]}},M=async()=>{try{const t=await a.hj.get(`${i.H}chat/models`,void 0,{_auth:!0});if(0===t.code&&t.data)return[null,t.data.list];throw t}catch(t){return["catch error"]}},A=async()=>{try{const t=await a.hj.get(`${i.H}chat-pay/order-detail`,void 0,{_auth:!0});if(0===t.code&&t.data)return[null,t.data];throw t}catch(t){return["catch error"]}},P=async t=>{try{const s=await a.hj.post(`${i.H}chat-pay/confirm-modify-plan`,{orderId:t},{_auth:!0});if(0===s.code&&s.data)return[null,s.data];throw s}catch(t){return["catch error"]}}},36160:(t,s,e)=>{e.r(s),e.d(s,{NEWCHAT_ID:()=>M,useChatGptStore:()=>k});var i=e(10435),a=e(95329),n=e(74891),r=e(84522),o=e(80661),c=e(77363),d=e(60385),h=e(54348);const l=function(t){return function(s,e,i){var a=Object(s);if(!(0,d.Z)(s)){var n=(0,c.Z)(e,3);s=(0,h.Z)(s),e=function(t){return n(a[t],t,a)}}var r=t(s,e,i);return r>-1?a[n?s[r]:r]:void 0}};var u=e(30967);const p=l(u.Z);var v=e(46146),g=e(60275),m=Math.max;const L=function(t,s,e){var i=null==t?0:t.length;if(!i)return-1;var a=null==e?0:(0,g.Z)(e);return a<0&&(a=m(i+a,0)),(0,v.Z)(t,(0,c.Z)(s,3),a)};var y=e(82410),f=e(88514),w=e(63477),I=e(13889);const T=new class{splitter="_e79218965e_";constructor(){this.restString=""}parser(t){const s=(this.restString+t).split(this.splitter).filter((t=>!!t));this.restString="";const e=[];return s.forEach(((s,i)=>{try{const t=JSON.parse(s);e.push(t)}catch(e){i===t.length-1&&(this.restString=s)}})),e}};var S=e(17319);const C=(0,a.useUserStore)(),M="newChat",A=()=>({name:"新的聊天",id:M,messages:[],updateTime:o().format("YYYY-MM-DD HH:mm")}),P=new class{constructor(t,s,e){this.state=s,this.type=t;const i=`${t}-retrieve`;I.y.listen(t,(t=>{this.state=t,null==e||e(t)})),I.y.listen(i,(()=>{I.y.post(t,this.state)})),setTimeout((()=>{I.y.post(i,null)}),50)}getState(){return this.state}setState(t){this.state=t,I.y.post(this.type,t)}}("client:chatai-pending",{pending:!1},(function(t){t.pending||b()})),k=(0,i.Q_)(r.BU.chatgpt,{syncStorage:{watch:["customLinks","panelType","linksList","chatTips","conversionList","planList","overLimit","historyTipsReaded","chatAssistantList","removedList","theme","vipGroup","closedExpiredTime","chatModelList"]},syncCloud:{watch:["customLinks","panelType","historyTipsReaded","theme","closedExpiredTime"]},state:()=>({modalShow:!1,linksList:[],selectedLink:null,panelType:"chatai",customLinks:[],conversionList:[A()],activeConversionId:M,chatTips:"世界上有多少人口？",pending:!1,chatLoading:!1,pagination:{pageNo:0,loading:!1,finished:!1},sponsorShow:!1,controller:null,tempId:void 0,planList:void 0,vipTipsShow:!1,vipTipsContent:"",overLimit:0,vipGroup:void 0,historyTipsReaded:!1,chatAssistantList:[],activeAssistantId:"",assistantListShow:!1,removedList:[],theme:"",panelShowType:"",orderList:[],closedExpiredTime:0,isRequestPage:!1,paymentOrderData:null,localCurrentTime:0,createOrderParams:{planId:"",payPlatform:""},payOrderIds:new Set,chatModelList:[],selectedModel:null,chatVipDetail:{name:"",rest:{"3d5":-1,4:-1}},isFreeOrder:!1}),getters:{conversionDataList(){return this.conversionList.map((t=>{var s,e;return{...t,name:(null===(s=t.messages[0])||void 0===s?void 0:s.content)||"新的聊天",updateTime:o(null===(e=t.messages[0])||void 0===e?void 0:e.updateTime).format("YYYY-MM-DD HH:mm")}}))},activeConversionItemOrigin(){const t=this.conversionList.find((t=>t.id===this.activeConversionId));return t||A()},assistantListMapper(){const t={};return this.chatAssistantList&&this.chatAssistantList.forEach((s=>{t[s.id]=s})),t},activeConversionItem(){const t=this.activeConversionItemOrigin;let s=null;return t.messages=t.messages.map((t=>{if("user"===t.role){s!==t.assistantId&&(t.newAssistant=!0),s=t.assistantId;const e=this.assistantListMapper[s];s&&t.newAssistant&&e?(t.assistantLogo=e.logo,t.assistantTitle=e.title):!t.newAssistant||s&&e||(t.assistantLogo=void 0,t.assistantTitle=void 0)}else if("assistant"===t.role){t.assistantId=s;const e=this.assistantListMapper[s];s&&e&&(t.assistantLogo=e.logo)}return t})),t},userOperationDisabled(){return!C.isLogin||this.pending||this.chatLoading},activeAssistant(){var t;return null===(t=this.chatAssistantList)||void 0===t?void 0:t.find((t=>t.id===this.activeAssistantId))},activeTheme(){return(0,a.useUserStore)().chatStatus.vip?this.theme?this.theme:"chat-purple":"chat-default"},activeSelectModel(){if(this.selectedModel)return this.selectedModel;const t=this.chatModelList.find((t=>t.default));return t||(this.chatModelList.length>0?this.chatModelList[0]:{abbName:"",id:"",name:"",limitKey:""})},operationDisabled(){let t=!1;return this.conversionDataList.forEach((s=>{s.messages.find((t=>t.loading||t.pending))&&(t=!0)})),t}},actions:{setModal(t){this.modalShow=t},setPanelType(t){this.panelType=t},setPanelShowType(t){this.panelShowType=t,"chat-expense"===this.panelType&&this.setPanelType("chatai")},setSelectLink(t){this.selectedLink=t},setVipGroup(t){this.vipGroup=t},addCustomLink(t){const s=[...this.customLinks];s.push(t),this.customLinks=s},removeCustomLink(t){const s=[...this.customLinks];s.splice(t,1),this.customLinks=s},removeOriginLink(t){t&&(this.removedList.unshift(t),this.removedList.length>10&&(this.removedList.length=10),this.removedList=[...this.removedList])},setActiveConversionId(t){this.activeConversionId=t},async deleteConversionItem(t){if(this.conversionList=this.conversionList.filter((s=>s.id!==t)),t===this.activeConversionId&&(this.conversionDataList.length>0?this.activeConversionId=this.conversionDataList[0].id:this.newChatHandler()),!this.isServerId(t))return;const[s,e]=await(0,n.x)(t)},newChatHandler(){const t={name:"新的聊天",id:M,messages:[],updateTime:o().format("YYYY-MM-DD HH:mm")};this.conversionList=[t,...this.conversionList],this.activeConversionId=M,this.activeAssistantId=""},async reqGptLinks(){const[t,s]=await(0,n.lk)();!t&&s&&(this.linksList=s,this.selectedLink=s[0])},resetPage(){this.conversionList=[A()],this.activeConversionId=M,this.planList=void 0,this.overLimit=0,this.vipGroup=void 0,this.pagination={pageNo:0,loading:!1,finished:!1}},async reqConversionList(t){var s;if(P.getState().pending)return void(this.activeConversionId=(null===(s=this.conversionList[0])||void 0===s?void 0:s.id)||M);if(this.pagination.loading||this.pagination.finished)return;this.pagination={...this.pagination,loading:!0};const[e,i]=await(0,n.pp)(this.pagination.pageNo);if(!e&&i){var a;if(t)this.conversionList=[A(),...i.list];else if(this.conversionList=[...this.conversionList,...i.list],this.activeConversionId===M)this.activeConversionId=(null===(a=i.list[0])||void 0===a?void 0:a.id)||M;i.totalPages-i.pageNo<=1?this.pagination={...this.pagination,finished:!0,loading:!1}:this.pagination={pageNo:i.pageNo+1,loading:!1,finished:!1}}},addUserMessage(t,s){const e=[...this.conversionList],i=e.find((t=>t.id===s));null==i||i.messages.push({role:"user",content:t,updateTime:o().valueOf(),assistantId:this.activeAssistantId||void 0}),this.conversionList=e},onClickTryIt(){this.sendChatMessage(this.chatTips,M)},async reqChatTips(){const[t,s]=await(0,n.Fh)();!t&&s&&(this.chatTips=s)},async reqAssistantList(){const[t,s]=await(0,n.Vq)();!t&&s&&(this.chatAssistantList=s)},updatePendingMessage(t){const s=[...this.conversionList],e=s.find((s=>s.id===t.conversionId)),i=e.messages.find((t=>t.loading));i&&(i.loading=!1,i.pending=!0),this.pending=!0,P.setState({pending:!0});const a=e.messages.find((t=>t.pending));if(t.error)return a.error=!0,a.content=t.content,a.pending=!1,a.extra=t.showNewBtn,this.pending=!1,this.conversionList=s,P.setState({pending:!1}),void(this.isRequestPage=!1);t.done&&(a.pending=!1,this.isServerId(t.conversionId)||t.id&&(e.id=t.id,this.activeConversionId=t.id),t.modelId&&(a.modelId=t.modelId),this.pending=!1,P.setState({pending:!1}),this.isRequestPage=!1),t.id&&(this.tempId=t.id),a.content+=t.content,this.conversionList=s},createLoadingMsg(t){const s=[...this.conversionList];s.find((s=>s.id===t)).messages.push({role:"assistant",content:"",loading:!0}),this.conversionList=s},setNewLocalId(){const t=this.conversionList.find((t=>t.id===M&&t.messages.length>0));t&&(t.id=this.createLocalId(),this.conversionList=[...this.conversionList])},createLocalId:()=>(0,w.kb)(M),isServerId:t=>!!t&&!t.startsWith(M),async sendChatMessage(t,s){if(this.operationDisabled)return void S.R.warn({message:"请等待当前对话完成..."});this.chatLoading=!0,this.controller=null;if(!this.conversionList.find((t=>t.id===s))){var e;let t=null===(e=this.conversionList[0])||void 0===e?void 0:e.id;t||(t=M,this.newChatHandler()),this.activeConversionId=t,s=t}this.addUserMessage(t,s),this.createLoadingMsg(s);const i=this.isServerId(s)?s:void 0,[a,r]=await(0,n.DX)(t,i,this.activeAssistantId,this.activeSelectModel.id);if(a||!r)return void this.updatePendingMessage({conversionId:s,content:"网络错误，请重试",error:!0,done:!0});this.isRequestPage=!0;const[o,c]=r;c&&(this.controller=c),this.chatLoading=!1,this.streamReaderToText(o,s)},readStreamWithTimeout:(t,s)=>new Promise(((e,i)=>{const a=setTimeout((()=>{i(new f.V("timeout"))}),s);t.read().then((t=>{clearTimeout(a),e(t)})).catch((t=>{clearTimeout(a),i(t)}))})),async streamReaderToText(t,s){try{const e=await this.readStreamWithTimeout(t,2e5);if(e.done)return;const i=e.value;let a="";a=new TextDecoder("utf-8").decode(i);const n=T.parser(a);this.handleChunksArray(n,s),this.streamReaderToText(t,s)}catch(t){this.isRequestPage=!1,P.setState({pending:!1}),"object"==typeof t&&(t instanceof f.V?this.abourtStream():null==t||t.name)}},deleteLastMessage(t,s){const e=[...this.conversionList],i=e.find((t=>t.id===s)),a=(0,u.Z)(i.messages,(s=>s.role===t));i.messages.splice(a,1),this.conversionList=e},updateLatestUserMessage(t){const s=[...this.conversionList],e=s.find((s=>s.id===t)),i=(0,u.Z)(null==e?void 0:e.messages,(t=>"user"===t.role));i>-1&&(e.messages[i].assistantId=this.activeAssistantId||void 0),this.conversionList=s},async reGenerateLastAnwser(t){if(this.operationDisabled)return void S.R.warn({message:"请等待当前对话完成..."});this.controller=null,this.chatLoading=!0;const s=[...this.conversionList].find((s=>s.id===t)),e=s.messages.find((t=>t.error));if(this.deleteLastMessage("assistant",t),e){const e=p(s.messages,(t=>"user"===t.role)).content;return this.deleteLastMessage("user",t),void this.sendChatMessage(e,t)}this.createLoadingMsg(t),this.updateLatestUserMessage(t);const[i,a]=await(0,n.B)(t,this.activeAssistantId,this.activeSelectModel.id);if(i||!a)return void this.updatePendingMessage({conversionId:t,content:"网络错误，请重试",error:!0,done:!0});this.isRequestPage=!0;const[r,o]=a;o&&(this.controller=o),this.chatLoading=!1,this.streamReaderToText(r,t)},handleChunksArray(t,s){t.forEach((t=>{switch(t.code){case 0:const{content:e,id:i}=t.data;this.updatePendingMessage({conversionId:s,content:e,id:i||""});break;case 5001:this.updatePendingMessage({conversionId:s,content:"",id:t.data.conversationId,modelId:t.data.modelId,done:!0}),t.data.restCount&&this.updateRestCount(t.data.restCount);break;case 4002:C.getProfile(),this.updatePendingMessage({conversionId:s,content:"系统错误，请重试",error:!0,done:!0});break;case 5002:this.setVipTipsShow(!0,"今日免费体验额度已达到上限"),this.setOverLimit(Date.now()),this.updatePendingMessage({conversionId:s,content:t.message||"系统错误",error:!0,done:!0});break;case 5003:case 1001:this.updatePendingMessage({conversionId:s,content:t.message||"系统错误",error:!0,done:!0});break;case 5004:this.updatePendingMessage({conversionId:s,content:t.message||"系统错误",error:!0,done:!0,showNewBtn:!0});break;default:this.updatePendingMessage({conversionId:s,content:t.message||"系统错误，请稍后重试",error:!0,done:!0})}}))},setSponsorShow(t){this.sponsorShow=t},setVipTipsShow(t,s){this.vipTipsShow=t,this.vipTipsContent=s},setOverLimit(t){this.overLimit=t},abourtStream(){this.controller&&(this.controller.abort(),this.controller=null,this.updatePendingMessage({conversionId:this.activeConversionId,content:"",id:this.tempId,done:!0}))},async getPlanList(){const[t,s]=await(0,n.t1)();t||(this.planList=s)},async getPayCode(t,s){const[e,i]=await(0,n.mr)(t,s);if(!e)return i},async getPayList(){const[t,s]=await(0,n.Hb)();if(!t)return s},async checkAllOrders(){const[t,s]=await(0,n.KC)(),e=s.chatai||{};return null===t&&(C.setChatStatus(e),e.vip)},async checkRecentOrderIds(t){const[s,e]=await(0,n.ud)(t);return null!==s?"":e.paidId},async getVipGroup(){const[t,s]=await(0,n.sT)();null===t&&this.setVipGroup(s)},readHistoryTips(){this.historyTipsReaded=!0},setActiveAssistant(t){this.activeAssistantId=t},setActiveAssistantToNext(){const t=L(this.chatAssistantList,(t=>t.id===this.activeAssistantId));t>-1?t===this.chatAssistantList.length-1?this.activeAssistantId="":this.activeAssistantId=this.chatAssistantList[t+1].id:this.activeAssistantId=this.chatAssistantList[0].id},setActiveAssistantToPrev(){const t=L(this.chatAssistantList,(t=>t.id===this.activeAssistantId));this.activeAssistantId=t>-1?0===t?"":this.chatAssistantList[t-1].id:this.chatAssistantList[this.chatAssistantList.length-1].id},setAssistantListStatus(t){var s;t&&null!==(s=this.chatAssistantList)&&void 0!==s&&s.length?this.assistantListShow=!0:this.assistantListShow=t},setStreamTimeout(t,s){this.updatePendingMessage({conversionId:t,content:"",id:this.tempId,done:!0,error:s})},setTheme(t){this.theme=t},async reqOrderList(t){const[s,e]=await(0,n.Fw)(t);null===s&&(this.orderList=e.list)},closeChatVipExpired(t){this.closedExpiredTime=t},unloadUpdatePending(){P.getState().pending&&this.isRequestPage&&P.setState({pending:!1})},mutTabspendingOver(){if(this.activeConversionId===M){this.conversionList.find((t=>t.id===M))||(this.activeConversionId=this.conversionList[0].id)}this.releasePending()},setCreateOrderParams(t){this.createOrderParams=t},async createPaymentOrder(t,s){const[e,i]=await(0,n.mr)(t,s);if(e)throw S.R.fail({message:e}),new Error(e);return this.paymentOrderData=i,this.isFreeOrder=0===this.paymentOrderData.newPlan.payAmount,this.localCurrentTime=Date.now(),this.payOrderIds.add(i.orderId),i},clearOrderIds(){this.payOrderIds.clear()},async getChatModels(){const[t,s]=await(0,n.fZ)();if(t||!s)return;const e=s.find((t=>t.default));e&&(this.selectedModel=e),this.chatModelList=s},setSelectModel(t){this.selectedModel=t},async getUserVipDetail(){const[t,s]=await(0,n.bI)();!t&&s&&(this.chatVipDetail=s)},async confirmChangePlanForFree(){if(!this.paymentOrderData)return;const[t,s]=await(0,n.wY)(this.paymentOrderData.orderId)},updateRestCount(t){this.chatVipDetail={...this.chatVipDetail,rest:t}},releasePending(){const t=[...this.conversionList];let s=!1;t.forEach((t=>{const e=t.messages.find((t=>t.loading||t.pending));e&&(s=!0,e.loading=!1,e.pending=!1)})),s&&(this.conversionList=t)}}});window.addEventListener("beforeunload",(()=>(k().unloadUpdatePending(),!0)));const b=(0,y.Z)(k().mutTabspendingOver,100)},88514:(t,s,e)=>{e.d(s,{V:()=>a,o:()=>i});const i=t=>{document.body.classList.remove("chat-default","chat-purple","chat-white"),document.body.classList.add(t)};class a extends Error{}},30967:(t,s,e)=>{e.d(s,{Z:()=>c});var i=e(46146),a=e(77363),n=e(60275),r=Math.max,o=Math.min;const c=function(t,s,e){var c=null==t?0:t.length;if(!c)return-1;var d=c-1;return void 0!==e&&(d=(0,n.Z)(e),d=e<0?r(c+d,0):o(d,c-1)),(0,i.Z)(t,(0,a.Z)(s,3),d,!0)}}}]);